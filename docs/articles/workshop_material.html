<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unlocking single cell spatial omics analyses with scdney • ScdneySpatial</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Unlocking single cell spatial omics analyses with scdney">
<meta property="og:description" content="ScdneySpatial">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ScdneySpatial</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/acknowledgements.html">Acknowledgement</a>
    </li>
    <li>
      <a href="../articles/workshop_material.html">Unlocking single cell spatial omics analyses with scdney</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/SydneyBioX/ScdneySpatial" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Unlocking single cell spatial omics analyses
with scdney</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/SydneyBioX/ScdneySpatial/blob/HEAD/vignettes/vignettes/workshop_material.Rmd" class="external-link"><code>vignettes/vignettes/workshop_material.Rmd</code></a></small>
      <div class="hidden name"><code>workshop_material.Rmd</code></div>

    </div>

    
    
<style>
.question {
  padding: 1em;
  background: lightcyan;
  color: black;
  border-radius: 10px;
}
</style>
<p><strong>Presenting Authors</strong></p>
<p>Farhan Ameen<span class="math inline">\(^{1,2,3}\)</span>, Alex
Qin<span class="math inline">\(^{1,2,3}\)</span>, Nick Robertson<span class="math inline">\(^{1,2,3}\)</span>, Ellis Patrick<span class="math inline">\(^{1,2,3}\)</span>.</p>
<p><span class="math inline">\(^1\)</span> Westmead Institute for
Medical Research, University of Sydney, Australia<br><span class="math inline">\(^2\)</span> Sydney Precision Data Science
Centre, University of Sydney, Australia<br><span class="math inline">\(^3\)</span> School of Mathematics and
Statistics, University of Sydney, Australia</p>
<p><br> Contact: ellis.patrick@sydney.edu.au</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Understanding the interplay between different types of cells and
their immediate environment is critical for understanding the mechanisms
of cells themselves and their function in the context of human diseases.
Recent advances in high dimensional in situ cytometry technologies have
fundamentally revolutionized our ability to observe these complex
cellular relationships providing an unprecedented characterisation of
cellular heterogeneity in a tissue environment.</p>
<div class="section level4">
<h4 id="description">Description<a class="anchor" aria-label="anchor" href="#description"></a>
</h4>
<p>In this workshop we will introduce some of the key analytical
concepts needed to analyse data from high dimensional spatial omics
technologies such as, PhenoCycler, IMC, Xenium and MERFISH. We will show
how functionality from our Bioconductor packages simpleSeg, FuseSOM,
scClassify, scHot, spicyR, listClust, statial, scFeatures and ClassifyR
can be used to address various biological hypotheses. By the end of this
workshop attendees will be able to implement and assess some of the key
steps of a spatial analysis pipeline including cell segmentation,
feature normalisation, cell type identification, microenvironment and
cell-state characterisation, spatial hypothesis testing and patient
classification. Understanding these key steps will provide attendees
with the core skills needed to interrogate the comprehensive spatial
information generated by these exciting new technologies.</p>
</div>
<div class="section level4">
<h4 id="pre-requisites">Pre-requisites<a class="anchor" aria-label="anchor" href="#pre-requisites"></a>
</h4>
<p>It is expected that students will have:</p>
<ul>
<li>basic knowledge of R syntax,</li>
<li>this workshop will not provide an in-depth description of
cell-resolution spatial omics technologies.</li>
</ul>
</div>
<div class="section level4">
<h4 id="r-bioconductor-packages-used">
<em>R</em> / <em>Bioconductor</em> packages used<a class="anchor" aria-label="anchor" href="#r-bioconductor-packages-used"></a>
</h4>
<p>Several single cell R packages will be used from the scdney package,
for more information visit: <a href="https://sydneybiox.github.io/scdney/" class="external-link uri">https://sydneybiox.github.io/scdney/</a>.</p>
</div>
<div class="section level4">
<h4 id="time-outline">Time outline<a class="anchor" aria-label="anchor" href="#time-outline"></a>
</h4>
<table class="table">
<thead><tr class="header">
<th>Activity</th>
<th>Time</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Data visualisation &amp; cell segmentation</td>
<td>1h 30m</td>
</tr>
<tr class="even">
<td>Cell type clustering &amp; classification</td>
<td>1h 30m</td>
</tr>
<tr class="odd">
<td>Spatial analysis &amp; feature generation</td>
<td>2h</td>
</tr>
<tr class="even">
<td>Patient Classification</td>
<td>1h 30m</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="learning-objectives">Learning objectives<a class="anchor" aria-label="anchor" href="#learning-objectives"></a>
</h4>
<ul>
<li>Understand and visualise spatial omics datasets.</li>
<li>Identify key biological questions that can be addressed with these
technologies and spatial analysis.</li>
<li>Understand the key analytical steps involved in spatial omics
analysis, and perform these steps using R.</li>
<li>Evaluate the performance of data normalisation and cell
segmentation.</li>
<li>Understand and generate individual feature representations from
spatial omics data.</li>
<li>Develop appreciation on how to assess performance of classification
models.</li>
<li>Perform disease outcome prediction using the feature representation
and robust classification framework.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="workshop">Workshop<a class="anchor" aria-label="anchor" href="#workshop"></a>
</h2>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<div class="section level4">
<h4 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h4>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"simpleSeg"</span>, <span class="st">"cytomapper"</span>, <span class="st">"scClassify"</span>, <span class="st">"scHOT"</span>, <span class="st">"FuseSOM"</span>,<span class="st">"glmnet"</span>, <span class="st">"spicyR"</span>, <span class="st">"lisaClust"</span>,<span class="st">"Statial"</span>, <span class="st">"scFeatures"</span>, <span class="st">"ClassifyR"</span>, <span class="st">"tidyverse"</span>, <span class="st">"scater"</span>, <span class="st">"SingleCellExperiment"</span>, <span class="st">"STexampleData"</span>, <span class="st">"SpatialDatasets"</span>, <span class="st">"tidySingleCellExperiment"</span>, <span class="st">"scuttle"</span>, <span class="st">"batchelor"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="download-datasets">Download datasets<a class="anchor" aria-label="anchor" href="#download-datasets"></a>
</h4>
<p>Please download these datasets before you start the workshop</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Download data now</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu">STexampleData</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/STexampleData/man/STexampleData.html" class="external-link">seqFISH_mouseEmbryo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">kerenSPE</span> <span class="op">=</span> <span class="fu">SpatialDatasets</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SpatialDatasets/man/SpatialDatasets.html" class="external-link">spe_Keren_2018</a></span><span class="op">(</span><span class="op">)</span> </span></code></pre></div>
</div>
<div class="section level4">
<h4 id="load-packages">Load packages<a class="anchor" aria-label="anchor" href="#load-packages"></a>
</h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># library(ScdneySpatial)</span></span>
<span></span>
<span><span class="co"># packages from scdney</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sydneybiox.github.io/ClassifyR/" class="external-link">ClassifyR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">FuseSOM</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ellispatrick.github.io/lisaClust/" class="external-link">lisaClust</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">scClassify</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sydneybiox.github.io/scFeatures/" class="external-link">scFeatures</a></span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">scHOT</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sydneybiox.github.io/simpleSeg/" class="external-link">simpleSeg</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/SydneyBioX/SpatialDatasets" class="external-link">SpatialDatasets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ellispatrick.github.io/spicyR/" class="external-link">spicyR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sydneybiox.github.io/Statial" class="external-link">Statial</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Other required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/BumpyMatrix" class="external-link">BumpyMatrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BodenmillerGroup/cytomapper" class="external-link">cytomapper</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">batchelor</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pharmaverse/ggsurvfit" class="external-link">ggsurvfit</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glmnet.stanford.edu" class="external-link">glmnet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com" class="external-link">plotly</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://had.co.nz/reshape" class="external-link">reshape</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioconductor.org/packages/scater/" class="external-link">scater</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">scuttle</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lmweber/STexampleData" class="external-link">STexampleData</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stemangiola/tidySingleCellExperiment" class="external-link">tidySingleCellExperiment</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nCores</span> <span class="op">&lt;-</span> <span class="fl">8</span>  <span class="co"># Feel free to parallelise things if you have the cores to spare.</span></span>
<span><span class="va">BPPARAM</span> <span class="op">&lt;-</span> <span class="fu">simpleSeg</span><span class="fu">:::</span><span class="fu"><a href="https://sydneybiox.github.io/simpleSeg/reference/generateBPParam.html" class="external-link">generateBPParam</a></span><span class="op">(</span><span class="va">nCores</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"celltype_colours.R"</span>, package <span class="op">=</span> <span class="st">"ScdneySpatial"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"restore_SingleCellExperiment_show"</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="module-1-data-exploration">Module 1: Data exploration<a class="anchor" aria-label="anchor" href="#module-1-data-exploration"></a>
</h3>
<p>In this workshop, we will be working with two datasets to explore how
biological phenotypes, cellular interactions, and patterns of gene
expression are correlated with disease. Both of these datasets will be
used in different contexts, hopefully these contexts are representative
of scenarios you will encounter in your own datasets.</p>
<p>We will use two motivating datasets:</p>
<ul>
<li>
<a href="https://www.cell.com/fulltext/S0092-8674(18)31100-0" class="external-link">Keren
et al, 2018</a>: A multiplexed ion beam imaging by time-of-flight
(MIBI-TOF) dataset profilining tissue from triple-negative breast cancer
patients. The primary question we will address with this dataset is if
we can predict risk of cancer recurrence and overall survival time based
on imaging data?</li>
<li>
<a href="https://www.nature.com/articles/s41587-021-01006-2" class="external-link">Lohoff
et al, 2022</a>: A seqFISH study of early mouse organogenesis. We will
use a subset of data that is made available from the STExampleData
package. The primary question we will address with this dataset is if we
can identify key transcriptomic drivers of the developing brain?</li>
</ul>
<p>The purpose of the this section is primarily to introduce the
<code>SpatialExperiment</code> class which is used to store information
from the imaging experiments in R. The goal will be to get comfortable
enough manipulating and exploring these objects so that you can progress
through the remainder of the workshop comfortably. Here we will download
a dataset stored in the <code>STexampleData</code> R package, examine
the structure, visualise the data and perform some exploratory
analyses.</p>
<div class="section level4">
<h4 id="spatial-transcriptomics---seqfish-mouse-embryo">Spatial transcriptomics - SeqFISH mouse embryo<a class="anchor" aria-label="anchor" href="#spatial-transcriptomics---seqfish-mouse-embryo"></a>
</h4>
<p>Here we download the seqFISH mouse embryo data. This comes in the
format of a <code>SpatialExperiment</code> object, where summarized
information from an imaging dataset can be compiled and accessed with
relative ease.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#spe &lt;- STexampleData::seqFISH_mouseEmbryo()</span></span>
<span><span class="va">spe</span></span></code></pre></div>
<p>We can use functions designed for <code>SingleCellExperiment</code>
objects in the <code>scater</code> package for plotting via the
<code>reducedDim</code> slot. We multiply the spatial coordinates by a
matrix to flip the y-axis and ensure we fix the aspect ratio.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scuttle/man/logNormCounts.html" class="external-link">logNormCounts</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span></span>
<span><span class="va">coord_transform</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"spatialCoords"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">coord_transform</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"spatialCoords"</span>, colour_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sox2"</span><span class="op">)</span>, point_size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li>How many cells are in this data?</li>
<li>How many genes?</li>
<li>Plot gene expression mapping point size to the cell area.</li>
</ol>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># try to answer the above question using the spe object. </span></span>
<span><span class="co"># you may want to check the SingleCellExperiment vignette.</span></span>
<span><span class="co"># https://bioconductor.org/packages/3.17/bioc/vignettes/SingleCellExperiment/inst/doc/intro.html</span></span></code></pre></div>
<p>We can perform a typical gene-expression based analysis for this
data. Later in part two we will perform some specific analytical
techniques, but for now let’s explore the dataset and use methods
designed for single cell data.</p>
<p>Typically in single-cell data analysis, we perform dimension
reduction to project the high dimensional cell x gene matrix on to 2D
space. This allows us to visualise various things of interest, such as
distribution of cell types and disease outcomes. Here, we will see how
cells are segregated by their expression of Sox2.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocSingular/man/runPCA.html" class="external-link">runPCA</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b.out</span> <span class="op">&lt;-</span> <span class="fu">batchelor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/batchelor/man/batchCorrect.html" class="external-link">batchCorrect</a></span><span class="op">(</span><span class="va">spe</span>, batch <span class="op">=</span> <span class="va">spe</span><span class="op">$</span><span class="va">pos</span>, assay.type <span class="op">=</span> <span class="st">"logcounts"</span>, PARAM<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/batchelor/man/BatchelorParam.html" class="external-link">FastMnnParam</a></span><span class="op">(</span>d<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"FastMnn"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">b.out</span>, <span class="st">"corrected"</span><span class="op">)</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/runUMAP.html" class="external-link">runUMAP</a></span><span class="op">(</span><span class="va">spe</span>, dimred <span class="op">=</span> <span class="st">"FastMnn"</span><span class="op">)</span></span>
<span><span class="va">spe</span></span>
<span></span>
<span><span class="va">g_celltype_umap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"UMAP"</span>, colour_by <span class="op">=</span> <span class="st">"celltype_mapped_refined"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">celltype_colours</span><span class="op">)</span></span>
<span><span class="va">g_celltype_umap</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"UMAP"</span>, colour_by <span class="op">=</span> <span class="st">"Sox2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g_celltype_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"spatialCoords"</span>, colour_by <span class="op">=</span> <span class="st">"celltype_mapped_refined"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">celltype_colours</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g_all</span> <span class="op">&lt;-</span> <span class="va">g_celltype_spatial</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span> <span class="va">g_celltype_umap</span></span>
<span><span class="va">g_all</span></span></code></pre></div>
<div class="question">
<p><strong>Advanced/Extension Question</strong></p>
<ol style="list-style-type: decimal">
<li>What considerations need to be made for batch correction of spatial
data? What assumptions are being made and/or broken? How could you check
this?</li>
<li>Check out the <a href="https://davidgohel.github.io/ggiraph/index.html" class="external-link"><code>ggiraph</code></a>
package for extending the <code>g_all</code> object to an interactive
plot with a tooltip that links the spatial and UMAP coordinate systems.
(Hint: This may involve generating a new ggplot object outside of the
<code>plotReducedDim</code> function.)</li>
</ol>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># try to examine answer the above questions using the spe object. </span></span>
<span><span class="co"># you may want to set up some small simulation..</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="spatial-proteomics---mibi-tof-breast-cancer">Spatial proteomics - MIBI-TOF breast cancer<a class="anchor" aria-label="anchor" href="#spatial-proteomics---mibi-tof-breast-cancer"></a>
</h4>
<p>As part of scdney package infrastructure, we provide several
pre-processed datasets which can be loaded in with the
<code>SpatialDatasets</code> package. Below, we’ve loaded in the
MIBI-TOF triple negative breast cancer data from Keren et al. into a
<code>SpatialExperiment</code> object.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load in Keren et al. data.</span></span>
<span><span class="co">#kerenSPE = SpatialDatasets::spe_Keren_2018() </span></span>
<span></span>
<span><span class="co"># Remove cold tumour types and patients with missing survival data.</span></span>
<span><span class="va">kerenSPE</span> <span class="op">=</span> <span class="va">kerenSPE</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tumour_type</span> <span class="op">!=</span> <span class="st">"cold"</span>,</span>
<span>         <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">`Survival_days_capped.`</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>event <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">Censored</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">kerenSPE</span>, <span class="st">"spatialCoords"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kerenSPE</span></span></code></pre></div>
<p>At the start of any analysis, it is often good to explore the data to
get a sense of complexity. We can do this by exploring the distribution
of the outcomes and variables in the patients’ meta-data.</p>
<p>Try starting off your exploration by answering the below
questions.</p>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li>How many cells are in this data?</li>
<li>How many markers? How many images?</li>
</ol>
</div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># try to answer the above question using the imc object. </span></span>
<span><span class="co"># you may want to check the SpatialExperiment vignette.</span></span>
<span><span class="co"># https://www.bioconductor.org/packages/release/bioc/vignettes/SpatialExperiment/inst/doc/SpatialExperiment.html</span></span></code></pre></div>
<p>Again, we can perform dimension reduction to visualize this dataset
on a 2D plane.</p>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li>Visualise the UMAP using the <code>plotReducedDim</code> function
and colour the UMAP by <code>cellType</code>. What does this UMAP tell
us?</li>
<li>What are some observations we could make if we coloured by
<code>imageID</code>?</li>
</ol>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">51773</span><span class="op">)</span></span>
<span><span class="va">kerenSPE</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/runUMAP.html" class="external-link">runUMAP</a></span><span class="op">(</span><span class="va">kerenSPE</span>, exprs_values <span class="op">=</span> <span class="st">"intensities"</span>, name <span class="op">=</span> <span class="st">"UMAP"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># try to answer the question here!</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="module-2-cell-segmentation">Module 2: Cell segmentation<a class="anchor" aria-label="anchor" href="#module-2-cell-segmentation"></a>
</h3>
<div class="section level4">
<h4 id="how-do-i-load-my-images-into-r">How do I load my images into R?<a class="anchor" aria-label="anchor" href="#how-do-i-load-my-images-into-r"></a>
</h4>
<p>To load in our images we use the <code>loadImages</code> function
from <code>cytomapper</code>, here we use the patient 5 image from Keren
et al. as an example.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">imageLocation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"kerenPatient5.tiff"</span>, package <span class="op">=</span> <span class="st">"ScdneySpatial"</span><span class="op">)</span></span>
<span><span class="va">image5</span> <span class="op">=</span> <span class="fu">cytomapper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cytomapper/man/loadImages.html" class="external-link">loadImages</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">imageLocation</span>,</span>
<span>  as.is <span class="op">=</span> <span class="cn">TRUE</span> <span class="co">#Needed as 8-bit image</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/Vector-class.html" class="external-link">mcols</a></span><span class="op">(</span><span class="va">image5</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"imageID"</span> <span class="op">=</span> <span class="st">"kerenPatient5"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Setting the channel names according to orginal paper. </span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/cytomapper/man/CytoImageList-naming.html" class="external-link">channelNames</a></span><span class="op">(</span><span class="va">image5</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Au"</span>, <span class="st">"Background"</span>, <span class="st">"Beta catenin"</span>, <span class="st">"Ca"</span>, <span class="st">"CD11b"</span>, <span class="st">"CD11c"</span>, <span class="st">"CD138"</span>, <span class="st">"CD16"</span>, <span class="st">"CD20"</span>, <span class="st">"CD209"</span>, <span class="st">"CD3"</span>, <span class="st">"CD31"</span>, <span class="st">"CD4"</span>, <span class="st">"CD45"</span>, <span class="st">"CD45RO"</span>, <span class="st">"CD56"</span>, <span class="st">"CD63"</span>, <span class="st">"CD68"</span>, <span class="st">"CD8"</span>, <span class="st">"dsDNA"</span>, <span class="st">"EGFR"</span>, <span class="st">"Fe"</span>, <span class="st">"FoxP3"</span>, <span class="st">"H3K27me3"</span>, <span class="st">"H3K9ac"</span>, <span class="st">"HLA_Class_1"</span>, <span class="st">"HLA_DR"</span>, <span class="st">"IDO"</span>, <span class="st">"Keratin17"</span>, <span class="st">"Keratin6"</span>, <span class="st">"Ki67"</span>, <span class="st">"Lag3"</span>, <span class="st">"MPO"</span>, <span class="st">"Na"</span>, <span class="st">"P"</span>, <span class="st">"p53"</span>, <span class="st">"Pan-Keratin"</span>, <span class="st">"PD-L1"</span>, <span class="st">"PD1"</span>, <span class="st">"phospho-S6"</span>, <span class="st">"Si"</span>, <span class="st">"SMA"</span>, <span class="st">"Ta"</span>, <span class="st">"Vimentin"</span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li>What class is image5? Hint: class()</li>
<li>How many images and markers are in image5?</li>
<li>Challenge: What is the dimension of the image5 image?</li>
</ol>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Answer questions here</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-do-i-visualise-my-images">How do I visualise my images?<a class="anchor" aria-label="anchor" href="#how-do-i-visualise-my-images"></a>
</h4>
<p>We can visualise this image to see what we have read in. Lets
highlight 4 markers.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualise segmentation performance another way.</span></span>
<span><span class="fu">cytomapper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cytomapper/man/plotPixels.html" class="external-link">plotPixels</a></span><span class="op">(</span></span>
<span>  image <span class="op">=</span> <span class="va">image5</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  colour_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD45"</span>, <span class="st">"Pan-Keratin"</span>, <span class="st">"SMA"</span>, <span class="st">"dsDNA"</span><span class="op">)</span>,</span>
<span>  colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    CD45 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"blue"</span><span class="op">)</span>,</span>
<span>    `Pan-Keratin` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"yellow"</span><span class="op">)</span>,</span>
<span>    SMA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"green"</span><span class="op">)</span>,</span>
<span>    dsDNA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can manipulate the brightness, contrast and gamma levels as
follows. See if you can do a better job.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualise segmentation performance another way.</span></span>
<span><span class="fu">cytomapper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cytomapper/man/plotPixels.html" class="external-link">plotPixels</a></span><span class="op">(</span></span>
<span>  image <span class="op">=</span> <span class="va">image5</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  colour_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD45"</span>, <span class="st">"Pan-Keratin"</span>, <span class="st">"SMA"</span>, <span class="st">"dsDNA"</span><span class="op">)</span>,</span>
<span>  display <span class="op">=</span> <span class="st">"single"</span>,</span>
<span>  colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    CD45 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span>,</span>
<span>    `Pan-Keratin` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"yellow"</span><span class="op">)</span>,</span>
<span>    SMA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"green"</span><span class="op">)</span>,</span>
<span>    dsDNA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"blue"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  ,</span>
<span>  <span class="co"># Adjust the brightness, contrast and gamma of each channel.</span></span>
<span>  bcg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    CD45 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    `Pan-Keratin` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    SMA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    dsDNA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  legend <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="can-we-identify-the-cells-in-the-image">Can we identify the cells in the image?<a class="anchor" aria-label="anchor" href="#can-we-identify-the-cells-in-the-image"></a>
</h4>
<p>The <code>EBImage</code> package on Bioconductor provides a lot of
useful functions for manipulating imaging data in R. This includes
functionality for finding cells, process called cell segmentation. Lets
work through an example from their vignette. This will use some
functionality that complements that which you’ve already learnt.</p>
<p>We start by loading the images of nuclei and cell bodies. To
visualize the cells we overlay these images as the green and the blue
channel of a false-color image. Notice, that with display you can
zoom!</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nuc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/io.html" class="external-link">readImage</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'images'</span>, <span class="st">'nuclei.tif'</span>, package<span class="op">=</span><span class="st">'EBImage'</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">cel</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/io.html" class="external-link">readImage</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'images'</span>, <span class="st">'cells.tif'</span>, package<span class="op">=</span><span class="st">'EBImage'</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="va">cells</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/channel.html" class="external-link">rgbImage</a></span><span class="op">(</span>green<span class="op">=</span><span class="fl">1.5</span><span class="op">*</span><span class="va">cel</span>, blue<span class="op">=</span><span class="va">nuc</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="va">cells</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We will next segment the nuclei. The <code>nuc</code> channel
contains fluorescent intensities of a protein expressed in the nuclei of
cells. First we create a nuclei mask which will threshold this channel
to separate signal from noise and then clean this with some
morphological operations. Then we identify single nuclei using
<code>bwlabel</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nmask</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/thresh.html" class="external-link">thresh</a></span><span class="op">(</span><span class="va">nuc</span>, w<span class="op">=</span><span class="fl">10</span>, h<span class="op">=</span><span class="fl">10</span>, offset<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">nmask</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/morphology.html" class="external-link">opening</a></span><span class="op">(</span><span class="va">nmask</span>, <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/morphology.html" class="external-link">makeBrush</a></span><span class="op">(</span><span class="fl">5</span>, shape<span class="op">=</span><span class="st">'disc'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nmask</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/fillHull.html" class="external-link">fillHull</a></span><span class="op">(</span><span class="va">nmask</span><span class="op">)</span></span>
<span><span class="va">nmask</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/bwlabel.html" class="external-link">bwlabel</a></span><span class="op">(</span><span class="va">nmask</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="va">nmask</span>, all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li>Do you understand what <code>nmask</code> is?</li>
<li>What are you seeing when you do <code>table(nmask)</code>
</li>
<li>What happens when you using <code><a href="https://rdrr.io/pkg/EBImage/man/colorLabels.html" class="external-link">colorLabels()</a></code> with
<code>display</code>?</li>
</ol>
</div>
<p>Next, we use the segmented nuclei as seeds to perform Voronoi
segmentation of the cytoplasm.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctmask</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/morphology.html" class="external-link">opening</a></span><span class="op">(</span><span class="va">cel</span><span class="op">&gt;</span><span class="fl">0.1</span>, <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/morphology.html" class="external-link">makeBrush</a></span><span class="op">(</span><span class="fl">5</span>, shape<span class="op">=</span><span class="st">'disc'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cmask</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/propagate.html" class="external-link">propagate</a></span><span class="op">(</span><span class="va">cel</span>, seeds<span class="op">=</span><span class="va">nmask</span>, mask<span class="op">=</span><span class="va">ctmask</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="va">ctmask</span>, all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We can then visualise our segmentations with
<code>paintObjects</code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">segmented</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/paintObjects.html" class="external-link">paintObjects</a></span><span class="op">(</span><span class="va">cmask</span>, <span class="va">cells</span>, col<span class="op">=</span><span class="st">'#ff00ff'</span><span class="op">)</span></span>
<span><span class="va">segmented</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/paintObjects.html" class="external-link">paintObjects</a></span><span class="op">(</span><span class="va">nmask</span>, <span class="va">segmented</span>, col<span class="op">=</span><span class="st">'#ffff00'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="va">segmented</span>, all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="can-we-do-this-in-one-step">Can we do this in one step?<a class="anchor" aria-label="anchor" href="#can-we-do-this-in-one-step"></a>
</h4>
<p>Images stored in a <code>list</code> or <code>CytoImageList</code>
can be segmented using <code>simpleSeg</code>. Below
<code>simpleSeg</code> will identify the nuclei in the image using the
<code>dsDNA</code>, <code>H3K27me3</code> and <code>H3K9ac</code>
channel. To estimate the cell body of the cells we will simply dilate
out from the nuclei by 3 pixels. We also have specified that the
channels be sqrt transformed, and the 99th quantile of values removed to
ensure our segmentation is not affected by outliers.</p>
<p>We can visualise the segmentations using the <code>display</code> and
<code>colorLabels</code> functions in <code>EBImage</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate segmentation masks</span></span>
<span><span class="va">masks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/simpleSeg/reference/simpleSeg.html" class="external-link">simpleSeg</a></span><span class="op">(</span></span>
<span>  <span class="va">image5</span>,</span>
<span>  nucleus <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dsDNA"</span>, <span class="st">"H3K27me3"</span>, <span class="st">"H3K9ac"</span><span class="op">)</span>,</span>
<span>  cellBody <span class="op">=</span> <span class="st">"dilate"</span>, </span>
<span>  transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sqrt"</span>, <span class="st">"norm99"</span><span class="op">)</span>,</span>
<span>  sizeSelection <span class="op">=</span> <span class="fl">40</span>,</span>
<span>  smooth <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  discSize <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  cores <span class="op">=</span> <span class="va">nCores</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="is-this-segmentation-appropriate">Is this segmentation appropriate?<a class="anchor" aria-label="anchor" href="#is-this-segmentation-appropriate"></a>
</h4>
<p>One way to assess if segmentation is appropriate is to look. We now
know two ways to do this.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualise segmentation performance one way.</span></span>
<span><span class="va">masks</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">EBImage</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/colorLabels.html" class="external-link">colorLabels</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">EBImage</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The <code>plotPixels</code> function in <code>cytomapper</code> makes
it easy to overlay the masks on top of the intensities of markers in the
image. Here we can s</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualise segmentation performance another way.</span></span>
<span><span class="fu">cytomapper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cytomapper/man/plotPixels.html" class="external-link">plotPixels</a></span><span class="op">(</span></span>
<span>  image <span class="op">=</span> <span class="va">image5</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  mask <span class="op">=</span> <span class="va">masks</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  img_id <span class="op">=</span> <span class="st">"imageID"</span>,</span>
<span>  colour_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD45"</span>, <span class="st">"Pan-Keratin"</span>, <span class="st">"SMA"</span>, <span class="st">"dsDNA"</span><span class="op">)</span>,</span>
<span>  display <span class="op">=</span> <span class="st">"single"</span>,</span>
<span>  colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    CD45 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span>,</span>
<span>    `Pan-Keratin` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"yellow"</span><span class="op">)</span>,</span>
<span>    SMA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"green"</span><span class="op">)</span>,</span>
<span>    dsDNA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"blue"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Adjust the brightness, contrast and gamma of each channel.</span></span>
<span>  bcg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    CD45 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    `Pan-Keratin` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    SMA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    dsDNA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  legend <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Using the <code>table</code> function in R we can measure the pixel
area of each cell and plot this on a histogram. In this dataset 1 µm is
equivalent to <span class="math inline">\(2.56\)</span> pixels, we can
transform the pixel area of a cell to physical area by dividing the
pixel area by <span class="math inline">\(2.56^2\)</span>. We can see
below the majority of our cells are just below <span class="math inline">\(100µm^2\)</span>, you should decide whether or not
this is an appropriate size based on your knowledge of the cell types
being imaged.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get area of every cell</span></span>
<span><span class="va">cellSize</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">masks</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">2.56</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter out first index, which represents background</span></span>
<span><span class="va">cellSize</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cellSize</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">30</span>,</span>
<span>       xlab <span class="op">=</span> <span class="st">"Pixel area of cell (µm^2)"</span>,</span>
<span>       main <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> </span></code></pre></div>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li><p>Do our segmentations look better if other parameters are used?
<em>Hint</em>: use the help function to see what other parameters are
available in <code>simpleSeg</code>.</p></li>
<li><p>We only have one image here, but how would you check the quality
of 100 images?</p></li>
</ol>
</div>
</div>
<div class="section level4">
<h4 id="im-happy-with-my-segmentation-how-do-i-create-an-spe-object">Im happy with my segmentation, how do I create an <code>SPE</code>
object?<a class="anchor" aria-label="anchor" href="#im-happy-with-my-segmentation-how-do-i-create-an-spe-object"></a>
</h4>
<p>With our segmentation <code>masks</code> we can convert our image to
a <code>SpatialExperiment</code> object using the
<code>measureObjects</code> function in <code>cytomapper</code>.
<code>measureObjects</code> will find the center of each cell and
represent the cell as an x and y coordinate. In addition the average
marker expression within each cell is summarised and stored in the
assays object of the <code>SpatialExperiment</code>. <em>NOTE:</em> If
you are using other segmentation tools or softwares, you can import the
masks as tiffs into R and use <code>measureObjects</code> to create a
<code>SpatialExperiment</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Summarise the expression of each marker in each cell</span></span>
<span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu">cytomapper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cytomapper/man/measureObjects.html" class="external-link">measureObjects</a></span><span class="op">(</span></span>
<span>  mask <span class="op">=</span> <span class="va">masks</span>,</span>
<span>  image <span class="op">=</span> <span class="va">image5</span>,</span>
<span>  feature_types <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basic"</span>, <span class="st">"moment"</span><span class="op">)</span>,</span>
<span>  basic_feature <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  moment_feature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cx"</span>, <span class="st">"cy"</span><span class="op">)</span>,</span>
<span>  img_id <span class="op">=</span> <span class="st">"imageID"</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="va">BPPARAM</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">cells</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="module-3-feature-normalisation">Module 3: Feature normalisation<a class="anchor" aria-label="anchor" href="#module-3-feature-normalisation"></a>
</h3>
<div class="section level4">
<h4 id="are-the-intensities-of-markers-consistent-across-images">Are the intensities of markers consistent across images?<a class="anchor" aria-label="anchor" href="#are-the-intensities-of-markers-consistent-across-images"></a>
</h4>
<p>Before moving onto annotating the cell types, we should check if the
marker intensities of each cell require any transformation or
normalisation. Here we examine the distribution of CD45 in each cell
across all the images, which is a general marker for immune cells. Below
we can see that the intensity of CD45 looks very skewed.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Joining the marker information with the cell information</span></span>
<span><span class="va">proteinIntensities</span> <span class="op">=</span> <span class="va">kerenSPE</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ttservice/man/join_features.html" class="external-link">join_features</a></span><span class="op">(</span>features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span>, shape <span class="op">=</span> <span class="st">"wide"</span>, assay <span class="op">=</span> <span class="st">"intensities"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the density of CD45 across all images.</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">proteinIntensities</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">CD45</span>, colour <span class="op">=</span> <span class="va">imageID</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-can-i-transform-and-normalise-my-data">How can I transform and normalise my data?<a class="anchor" aria-label="anchor" href="#how-can-i-transform-and-normalise-my-data"></a>
</h4>
<p>We can transform and normalise our data using the
<code>normalizeCells</code> function in <code>simpleSeg</code>. Here we
have taken the intensities from the <code>intensities</code> assay,
performed a asinh transform, then for each image trimmed the 99 quantile
and min-max scaled to 0-1. In addition to this we have performed
principle component analysis, and regressed out the first PC. This
modified data is then stored in the <code>normIntensities</code> assay.
We can see that the distribution of CD45 looks much less skewed than
before.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kerenSPE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/simpleSeg/reference/normalizeCells.html" class="external-link">normalizeCells</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  transformation <span class="op">=</span> <span class="st">"asinh"</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trim99"</span>, <span class="st">"minMax"</span>, <span class="st">"PC1"</span><span class="op">)</span>,</span>
<span>  assayIn <span class="op">=</span> <span class="st">"intensities"</span>,</span>
<span>  assayOut <span class="op">=</span> <span class="st">"normIntensities"</span>,</span>
<span>  cores <span class="op">=</span> <span class="va">nCores</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">normProteinIntensities</span> <span class="op">=</span> <span class="va">kerenSPE</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ttservice/man/join_features.html" class="external-link">join_features</a></span><span class="op">(</span>features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span>, shape <span class="op">=</span> <span class="st">"wide"</span>, assay <span class="op">=</span> <span class="st">"normIntensities"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">normProteinIntensities</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">CD3</span>, colour <span class="op">=</span> <span class="va">imageID</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li><p>CD3 is a marker which characterises T cells, plot the
distribution of CD3. What does it look like? What does this tell us
about T cells in our dataset.</p></li>
<li><p>If we set <code>cellType == "CD4_T_cell"</code> is this
concordant with the conclusion you made in question 1.</p></li>
</ol>
</div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Answer question here</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="module-4-cell-type-annotation">Module 4: Cell type annotation<a class="anchor" aria-label="anchor" href="#module-4-cell-type-annotation"></a>
</h3>
<div class="section level4">
<h4 id="can-we-use-a-clustering-approach-to-identify-cell-types">Can we use a clustering approach to identify cell types?<a class="anchor" aria-label="anchor" href="#can-we-use-a-clustering-approach-to-identify-cell-types"></a>
</h4>
<p>Here we cluster using the <code>runFuseSOM</code> function from
<code>FuseSOM</code>. We have chosen to specify the same subset of
markers used in the original manuscript for gating cell types. We have
also specified the number of clusters to identify to be
<code>numClusters = 17</code>.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">useMarkers</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD45"</span>, <span class="st">"FoxP3"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"CD3"</span>, <span class="st">"CD20"</span>, <span class="st">"CD16"</span>, <span class="st">"CD68"</span>, <span class="st">"MPO"</span>, <span class="st">"HLA.DR"</span>, <span class="st">"Pan.Keratin"</span>, <span class="st">"Keratin17"</span>, <span class="st">"Keratin6"</span>, <span class="st">"p53"</span>, <span class="st">"Beta.catenin"</span>, <span class="st">"EGFR"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">51773</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kerenSPE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FuseSOM/man/runFuseSOM.html" class="external-link">runFuseSOM</a></span><span class="op">(</span></span>
<span>  <span class="va">kerenSPE</span>,</span>
<span>  markers <span class="op">=</span> <span class="va">useMarkers</span>,</span>
<span>  assay <span class="op">=</span> <span class="st">"normIntensities"</span>,</span>
<span>  numClusters <span class="op">=</span> <span class="fl">17</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="how-do-i-interpret-my-clusters">How do I interpret my clusters?<a class="anchor" aria-label="anchor" href="#how-do-i-interpret-my-clusters"></a>
</h4>
<p>We can begin the process of understanding what each of these cell
clusters are by using the <code>plotGroupedHeatmap</code> function from
<code>scater</code>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotGroupedHeatmap.html" class="external-link">plotGroupedHeatmap</a></span><span class="op">(</span></span>
<span>  <span class="va">kerenSPE</span>,</span>
<span>  features <span class="op">=</span> <span class="va">useMarkers</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"clusters"</span>,</span>
<span>  exprs_values <span class="op">=</span> <span class="st">"normIntensities"</span>,</span>
<span>  center <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  scale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  cluster_rows <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li>Have we captured distinct cell populations? Can you identify any of
the clusters?</li>
<li>Run the code below to compare the cell types in the dataset to the
clusters we have identified. How do our clusters compare? Are there any
clusters that should be combined?</li>
</ol>
</div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Type your answer here</span></span>
<span></span>
<span></span>
<span><span class="co"># Question 2 code</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lisaClust/man/regionMap.html" class="external-link">regionMap</a></span><span class="op">(</span><span class="va">kerenSPE</span>, cellType <span class="op">=</span> <span class="st">"clusters"</span>, region <span class="op">=</span> <span class="st">"cellType"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">0.5</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Cell types in data"</span>, y <span class="op">=</span> <span class="st">"Our clusters"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="what-is-an-appropriate-number-of-clusters">What is an appropriate number of clusters?<a class="anchor" aria-label="anchor" href="#what-is-an-appropriate-number-of-clusters"></a>
</h4>
<p>Great question! There is no right answer here, however there are
several statistics which can be used to estimate the “true” number of
clusters. We can use the <code>estimateNumCluster</code> and
<code>optiPlot</code> functions from <code>FuseSOM</code> to examine if
our choice of 17 clusters is reasonable. Here we use the gap statistic,
other methods such as jump, slope, silhouette and within cluster
distance (wcd) are also available.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kerenSPE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FuseSOM/man/estimateNumCluster.html" class="external-link">estimateNumCluster</a></span><span class="op">(</span><span class="va">kerenSPE</span>, kSeq <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/FuseSOM/man/optiPlot.html" class="external-link">optiPlot</a></span><span class="op">(</span><span class="va">kerenSPE</span>, method <span class="op">=</span> <span class="st">"gap"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kerenSPE</span><span class="op">@</span><span class="va">metadata</span><span class="op">$</span><span class="va">clusterEstimation</span><span class="op">$</span><span class="va">Discriminant</span></span></code></pre></div>
<p>Finally we can run a UMAP to examine how distinct our clusters are
from one another.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">51773</span><span class="op">)</span></span>
<span><span class="co"># Perform dimension reduction using UMP.</span></span>
<span><span class="va">kerenSPE</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/runUMAP.html" class="external-link">runUMAP</a></span><span class="op">(</span></span>
<span>  <span class="va">kerenSPE</span>,</span>
<span>  subset_row <span class="op">=</span> <span class="va">useMarkers</span>,</span>
<span>  exprs_values <span class="op">=</span> <span class="st">"normIntensities"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"normUMAP"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># UMAP by cell type cluster.</span></span>
<span><span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span></span>
<span>  <span class="va">kerenSPE</span>,</span>
<span>  dimred <span class="op">=</span> <span class="st">"normUMAP"</span>,</span>
<span>  colour_by <span class="op">=</span> <span class="st">"clusters"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li>How does this UMAP compare to the original UMAP?</li>
</ol>
</div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Answer question here.</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="what-if-i-dont-have-an-expert-to-annotate-my-cell-types">What if I don’t have an expert to annotate my cell types?<a class="anchor" aria-label="anchor" href="#what-if-i-dont-have-an-expert-to-annotate-my-cell-types"></a>
</h4>
<p>Cell type clustering may difficult without the aid of domain experts
who know how many cell types to expect and are able to annotate the
clusters. Cell type classification is an alternative approach to
clustering which annotates cell types based on an expert labeled
reference dataset.</p>
<p>To do so we will use <code>scClassify</code>. Below we will use the
intensities an cell type annotations from the <code>kerenSPE</code>
dataset to predict the cell types in image 5.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Splitting data to train and test sets</span></span>
<span><span class="va">kerenSPE_train</span> <span class="op">=</span> <span class="va">kerenSPE</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">imageID</span> <span class="op">!=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kerenSPE_test</span> <span class="op">=</span> <span class="va">kerenSPE</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">imageID</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Converting intensities to dgCMatrix</span></span>
<span><span class="va">train_intensities</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">kerenSPE_train</span>, <span class="st">"intensities"</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span> <span class="st">"dgCMatrix"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">test_intensities</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">kerenSPE_test</span>, <span class="st">"intensities"</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span> <span class="st">"dgCMatrix"</span><span class="op">)</span></span></code></pre></div>
<p><code>scClassify</code> first constructs a cell type tree from the
training dataset, where cells are organised in a hierarchy with
increasingly fined tuned annotations, here we use the
<code>HOPACH</code> method to construct this tree. This tree is
constructed using the proteins which are differentially expressed
between one cell type to all the other cells, identified using
<code>limma</code>. To annotate the cells in the unlabeled dataset, the
unlabeled cells are projected into a lower dimensional space and a
weighted KNN (<code>WKNN</code>) is used to classify unlabeled cells to
their closest neighbours using <code>pearson</code> correlation as the
distance metric.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scClassifyResults</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/scClassify/man/scClassify.html" class="external-link">scClassify</a></span><span class="op">(</span>exprsMat_train <span class="op">=</span> <span class="va">train_intensities</span>, </span>
<span>                            cellTypes_train <span class="op">=</span> <span class="va">kerenSPE_train</span><span class="op">$</span><span class="va">cellType</span>,</span>
<span>                            exprsMat_test <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>keren5 <span class="op">=</span> <span class="va">test_intensities</span><span class="op">)</span>,</span>
<span>                            tree <span class="op">=</span> <span class="st">"HOPACH"</span>,</span>
<span>                            algorithm <span class="op">=</span> <span class="st">"WKNN"</span>,</span>
<span>                            selectFeatures <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"limma"</span><span class="op">)</span>,</span>
<span>                            similarity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pearson"</span><span class="op">)</span>,</span>
<span>                            returnList <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                            verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                            BPPARAM <span class="op">=</span> <span class="va">BPPARAM</span><span class="op">)</span></span></code></pre></div>
<p>To save time we have preloaded in the <code>scClassify</code>
results, below we can view the hierarchical tree constructed by
<code>scClassify</code>.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"scClassifyResults.rda"</span>, package <span class="op">=</span> <span class="st">"ScdneySpatial"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/scClassify/man/plotCellTypeTree.html" class="external-link">plotCellTypeTree</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/scClassify/man/cellTypeTree.html" class="external-link">cellTypeTree</a></span><span class="op">(</span><span class="va">scClassifyResults</span><span class="op">$</span><span class="va">trainRes</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Having a look at some of the predictions, we can observe some cells
belonging to multiple cell types. These represent cells which are
classified as parent populations in the hierarchical tree. Here we clean
up the names to make plotting easier. We can compare our original labels
to our classified labels to get a sense of how concordant our
predictions are. As you can see, around 68% of the cell types have
identical labels between the original and classified cell types.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">classifiedCellTypes</span> <span class="op">=</span> <span class="va">scClassifyResults</span><span class="op">$</span><span class="va">testRes</span><span class="op">$</span><span class="va">keren5</span><span class="op">$</span><span class="va">pearson_WKNN_limma</span><span class="op">$</span><span class="va">predRes</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">classifiedCellTypes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">newCellTypes</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>  <span class="va">classifiedCellTypes</span> <span class="op">==</span> <span class="st">"Keratin_Tumour_Unidentified_Other_Immune_Endothelial_Mesenchymal_Tumour"</span> <span class="op">~</span> <span class="st">"Tumour_parent"</span>,</span>
<span>  <span class="va">classifiedCellTypes</span> <span class="op">==</span> <span class="st">"Other_Immune_Endothelial_Mesenchymal"</span> <span class="op">~</span> <span class="st">"Structural_parent"</span>,</span>
<span>  <span class="va">classifiedCellTypes</span> <span class="op">==</span> <span class="st">"Macrophages_Mono_or_Neu"</span> <span class="op">~</span> <span class="st">"Monocyte_subparent"</span>,</span>
<span>  <span class="va">classifiedCellTypes</span> <span class="op">==</span> <span class="st">"DC_or_Mono_Macrophages_Mono_or_Neu"</span> <span class="op">~</span> <span class="st">"Monocyte_parent"</span>,</span>
<span>  <span class="va">classifiedCellTypes</span> <span class="op">==</span> <span class="st">"dn_T_CD3_B_cell_CD4_T_cell_DC_or_Mono_Macrophages_CD8_T_cell_Mono_or_Neu_Neutrophils_NK_DC_Tregs"</span> <span class="op">~</span> <span class="st">"Immune_parent"</span>,</span>
<span>  <span class="va">classifiedCellTypes</span> <span class="op">==</span> <span class="st">"dn_T_CD3_CD4_T_cell_CD8_T_cell"</span> <span class="op">~</span> <span class="st">"Tcell_parent"</span>,</span>
<span>  <span class="va">classifiedCellTypes</span> <span class="op">==</span> <span class="st">"Endothelial_Mesenchymal"</span> <span class="op">~</span> <span class="st">"Structural_parent"</span>,</span>
<span>  <span class="va">classifiedCellTypes</span> <span class="op">==</span> <span class="st">"dn_T_CD3_B_cell_CD4_T_cell_CD8_T_cell"</span> <span class="op">~</span> <span class="st">"Lymphocytes_parent"</span>,</span>
<span>  <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">classifiedCellTypes</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">kerenSPE_test</span><span class="op">$</span><span class="va">classifiedCellTypes</span> <span class="op">=</span> <span class="va">newCellTypes</span></span>
<span></span>
<span></span>
<span><span class="op">(</span><span class="va">kerenSPE_test</span><span class="op">$</span><span class="va">cellType</span> <span class="op">==</span> <span class="va">kerenSPE_test</span><span class="op">$</span><span class="va">classifiedCellTypes</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="viewing-images">Viewing images<a class="anchor" aria-label="anchor" href="#viewing-images"></a>
</h4>
<p>We can look at the distribution of cells in an image. Here we compare
our clusters and classified cell types to the cell types in the
dataset.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">kerenSPE</span>, <span class="st">"spatialCoords"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kerenSPE</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">imageID</span> <span class="op">==</span> <span class="st">"5"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="st">"spatialCoords"</span>, colour_by <span class="op">=</span> <span class="st">"clusters"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Our clusters"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">kerenSPE_test</span>, <span class="st">"spatialCoords"</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">kerenSPE_test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kerenSPE_test</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="st">"spatialCoords"</span>, colour_by <span class="op">=</span> <span class="st">"classifiedCellTypes"</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="va">kerenSPE</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">imageID</span> <span class="op">==</span> <span class="st">"5"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="st">"spatialCoords"</span>, colour_by <span class="op">=</span> <span class="st">"cellType"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Original cell types"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Comparing orignal cell types to clustering and classification cell types. </span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lisaClust/man/regionMap.html" class="external-link">regionMap</a></span><span class="op">(</span><span class="va">kerenSPE</span>, cellType <span class="op">=</span> <span class="st">"clusters"</span>, region <span class="op">=</span> <span class="st">"cellType"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">0.5</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Original vs Clustered"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lisaClust/man/regionMap.html" class="external-link">regionMap</a></span><span class="op">(</span><span class="va">kerenSPE_test</span>, cellType <span class="op">=</span> <span class="st">"classifiedCellTypes"</span>, region <span class="op">=</span> <span class="st">"cellType"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">0.5</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Original vs Classified"</span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li>Discuss amongst your peers, why might there be differences between
the clusters, the classified cell types and the original cell type
labels in the dataset?</li>
</ol>
</div>
</div>
</div>
<div class="section level3">
<h3 class="tabset" id="module-5-single-sample-analysis">Module 5: Single sample analysis<a class="anchor" aria-label="anchor" href="#module-5-single-sample-analysis"></a>
</h3>
<p>In this module we focus on examining gene expression patterns in a
single image, from the SeqFISH mouse embryo dataset.</p>
<div class="section level4">
<h4 id="are-there-genes-which-change-expression-across-space">Are there genes which change expression across space?<a class="anchor" aria-label="anchor" href="#are-there-genes-which-change-expression-across-space"></a>
</h4>
<p>Here we will ask which gene patterns we observe to be changing across
the <code>spe$gutRegion</code> cell type in space. Note that we want to
assess the anatomical region corresponding to the anterior end of the
developing gut developing brain so we will first subset the cells using
the spatial coordinates. We can check what we have selected by
plotting.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Filter cells which are labeled gut tub, and in the anterior section.</span></span>
<span><span class="va">spe</span><span class="op">$</span><span class="va">gutRegion</span> <span class="op">&lt;-</span> <span class="va">spe</span><span class="op">$</span><span class="va">celltype_mapped_refined</span> <span class="op">==</span> <span class="st">"Gut tube"</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"spatialCoords"</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.5</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"spatialCoords"</span>, colour_by <span class="op">=</span> <span class="st">"gutRegion"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Let’s subset the data to only these cells and continue with our scHOT
analysis.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spe_gut</span> <span class="op">&lt;-</span> <span class="va">spe</span><span class="op">[</span>,<span class="va">spe</span><span class="op">$</span><span class="va">gutRegion</span><span class="op">]</span></span>
<span><span class="va">spe_gut</span></span></code></pre></div>
<p>We select genes with at least some proportion of expressed cells for
testing, and create the <code>scHOT</code> object.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">counts</a></span><span class="op">(</span><span class="va">spe_gut</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span>, <span class="fl">40</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gene_to_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">spe_gut</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">counts</a></span><span class="op">(</span><span class="va">spe_gut</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.2</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">gene_to_test</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">gene_to_test</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">gene_to_test</span>, <span class="fl">1</span>, <span class="va">paste0</span>, collapse <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gene_to_test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scHOT_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scHOT/man/scHOT_buildFromSCE.html" class="external-link">scHOT_buildFromSCE</a></span><span class="op">(</span><span class="va">spe_gut</span>,</span>
<span>                                    assayName <span class="op">=</span> <span class="st">"logcounts"</span>,</span>
<span>                                    positionType <span class="op">=</span> <span class="st">"spatial"</span>,</span>
<span>                                    positionColData <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x_global_affine"</span>, <span class="st">"y_global_affine"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scHOT_spatial</span></span></code></pre></div>
<p>We now add the testing scaffold to the <code>scHOT</code> object, and
set the local weight matrix for testing, with a choice of span of 0.1
(the proportion of cells to weight around each cell). We can speed up
computation by not requiring the weight matrix correspond to every
individual cell, but instead a random selection among all the cells
using the <code>thin</code> function.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scHOT_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scHOT/man/scHOT_addTestingScaffold.html" class="external-link">scHOT_addTestingScaffold</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>, <span class="va">gene_to_test</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">scHOT_spatial</span><span class="op">@</span><span class="va">testingScaffold</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scHOT_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scHOT/man/scHOT_setWeightMatrix.html" class="external-link">scHOT_setWeightMatrix</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>, span <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">scHOT_spatial</span><span class="op">@</span><span class="va">weightMatrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scHOT/man/thin.html" class="external-link">thin</a></span><span class="op">(</span><span class="va">scHOT_spatial</span><span class="op">@</span><span class="va">weightMatrix</span>, n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">slot</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>, <span class="st">"weightMatrix"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For a given cell we can visually examine the local weight given by
the span parameter.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cellID</span> <span class="op">=</span> <span class="fl">10</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">scHOT_spatial</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      W <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">slot</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>, <span class="st">"weightMatrix"</span><span class="op">)</span><span class="op">[</span><span class="va">cellID</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_global_affine</span>, y <span class="op">=</span> <span class="op">-</span><span class="va">y_global_affine</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">W</span>, size <span class="op">=</span> <span class="va">W</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_colour_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"black"</span>, high <span class="op">=</span> <span class="st">"purple"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size_continuous</a></span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">2.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Spatial Weight"</span><span class="op">)</span>,</span>
<span>         size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Spatial Weight"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Central cell: "</span>, <span class="va">cellID</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="cn">NULL</span></span></code></pre></div>
<div class="question">
<p><strong>Question</strong></p>
<ol style="list-style-type: decimal">
<li>How will the results change if the span is increased/decreased?</li>
</ol>
</div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Make associated changes to the code to test out the question above.</span></span></code></pre></div>
<p>We set the higher order function as the weighted mean function, and
then calculate the observed higher order test statistics. This may take
around 10 seconds.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scHOT_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scHOT/man/scHOT_calculateGlobalHigherOrderFunction.html" class="external-link">scHOT_calculateGlobalHigherOrderFunction</a></span><span class="op">(</span></span>
<span>    <span class="va">scHOT_spatial</span>,</span>
<span>    higherOrderFunction <span class="op">=</span> <span class="va">weightedMean</span>,</span>
<span>    higherOrderFunctionType <span class="op">=</span> <span class="st">"weighted"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">slot</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>, <span class="st">"scHOT_output"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scHOT_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scHOT/man/scHOT_calculateHigherOrderTestStatistics.html" class="external-link">scHOT_calculateHigherOrderTestStatistics</a></span><span class="op">(</span></span>
<span>    <span class="va">scHOT_spatial</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Now we can plot the overall mean versus the scHOT statistic to
observe any relationship. Labels can be interactively visualised using
<code>ggplotly</code>. Some genes may have different distributions so we
turn to permutation testing to assess statistical significance.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">scHOT_spatial</span><span class="op">@</span><span class="va">scHOT_output</span><span class="op">)</span>, </span>
<span>           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">globalHigherOrderFunction</span>, y <span class="op">=</span> <span class="va">higherOrderStatistic</span>, label <span class="op">=</span> <span class="va">gene_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Mean across all cells"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"scHOT statistic for local weightedMean"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">g</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/plotly/man/ggplotly.html" class="external-link">ggplotly</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span></code></pre></div>
<p>Set up the permutation testing schema. For the purposes of this
workshop we set a low number of permutations over a low number of genes
in the testing scaffold, you may want to change this as you work through
the workshop yourself. The testing will take a few minutes to run, here
with the parallel parameters that were set at the beginning of this
document.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scHOT_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scHOT/man/scHOT_setPermutationScaffold.html" class="external-link">scHOT_setPermutationScaffold</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>,</span>
<span>                                              numberPermutations <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                              numberScaffold <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scHOT_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scHOT/man/scHOT_performPermutationTest.html" class="external-link">scHOT_performPermutationTest</a></span><span class="op">(</span></span>
<span>    <span class="va">scHOT_spatial</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    parallel <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">slot</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>, <span class="st">"scHOT_output"</span><span class="op">)</span></span></code></pre></div>
<p>After the permutation test we can estimate the P-values across all
genes.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/scHOT/man/scHOT_plotPermutationDistributions.html" class="external-link">scHOT_plotPermutationDistributions</a></span><span class="op">(</span><span class="va">scHOT_spatial</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scHOT_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scHOT/man/scHOT_estimatePvalues.html" class="external-link">scHOT_estimatePvalues</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>,</span>
<span>                                       nperm_estimate <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                                       maxDist <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">slot</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>, <span class="st">"scHOT_output"</span><span class="op">)</span></span></code></pre></div>
<p>We can now examine the spatial expression of the 5 most significant
genes, both in our scHOT object and over our original spe object.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output_sorted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">slot</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>, <span class="st">"scHOT_output"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">slot</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>,</span>
<span>                                                                <span class="st">"scHOT_output"</span><span class="op">)</span><span class="op">$</span><span class="va">pvalEstimated</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">topgenes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">output_sorted</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>, <span class="st">"spatialCoords"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"spatialCoords"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">scHOT_spatial</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">topgene</span> <span class="kw">in</span> <span class="va">topgenes</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">g_spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"spatialCoords"</span>, colour_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">topgene</span><span class="op">)</span>, point_size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">g_scHOT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">scHOT_spatial</span>, <span class="st">"spatialCoords"</span>, colour_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">topgene</span><span class="op">)</span>, point_size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                           by_exprs_values <span class="op">=</span> <span class="st">"expression"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">g_all</span> <span class="op">&lt;-</span> <span class="va">g_scHOT</span> <span class="op">+</span> <span class="va">g_spe</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">g_all</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here we are noting the genes that are found to have the most
statistically significant spatial variation in their local mean
expression. These genes point to specific patterns that govern the
development of individual parts of the gut tube.</p>
<div class="question">
<p><strong>Advanced/Extended Questions</strong></p>
<ol style="list-style-type: decimal">
<li>How would you perform such testing over multiple distinct
samples?</li>
<li>scHOT is developed with all higher order testing in mind, use the
associated <a href="http://www.bioconductor.org/packages/release/bioc/html/scHOT.html" class="external-link">vignette</a>
to get towards assessing changes in variation or correlation structure
in space.</li>
</ol>
</div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## try some code</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="module-6-multi-sample-analysis">Module 6: Multi-sample analysis<a class="anchor" aria-label="anchor" href="#module-6-multi-sample-analysis"></a>
</h3>
<p>The following module will examine how we can extract different
spatial and molecular features from multi-sample datasets. These
features can be used to extract some biological understanding. Here we
use the MIBI-TOF breast cancer dataset.</p>
<div class="section level4">
<h4 class="tabset" id="can-i-measure-if-two-cell-types-are-co-localised">Can I measure if two cell types are
co-localised?<a class="anchor" aria-label="anchor" href="#can-i-measure-if-two-cell-types-are-co-localised"></a>
</h4>
<p><code>Kontextual</code> is a part of the <code>Statial</code> package
which models spatial relationships between cells in the context of
hierarchical cell lineage structures. By assessing spatial relationships
between pairs of cells in the context of other related cell types,
Kontextual provides robust quantification of cell type relationships
which are invariant to changes in tissue structure.</p>
<p>For the purposes of using <code>Kontextual</code> we define cell
functions as identified clusters of cells, where larger clusters
represent a “parent” cell population, and finer sub-clusters
representing a “child” cell population with a particular function. For
example, CD4+ T cells have a highly specified function, and may be
considered a child to a larger parent population of T cells.
<code>Kontextual</code> thus aims to quantify how the localisation
patterns of a child population of cells deviate from the spatial
behaviour of their parent population, and how their cellular function
defines their spatial localisation.</p>
<div class="section level5">
<h5 id="cell-type-hierarchy">Cell type hierarchy<a class="anchor" aria-label="anchor" href="#cell-type-hierarchy"></a>
</h5>
<p>A key input for <code>Kontextual</code> is an annotation of cell type
hierarchies. We will need these to organise all the cells present into
cell state populations or clusters, e.g. all the different B cell types
are put in a vector called <code>bcells.</code></p>
<p>To make our lives easier, we will start by defining these here. I’m
happy to talk about how we use our bioconductor package <a href="http://www.bioconductor.org/packages/release/bioc/html/treekoR.html" class="external-link">treekoR</a>
to define these hierarchies in a data driven way.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up cell populations</span></span>
<span></span>
<span><span class="va">tumour</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Keratin_Tumour"</span>, <span class="st">"Tumour"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bcells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B_cell"</span><span class="op">)</span></span>
<span><span class="va">tcells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dn_T_cell"</span>, <span class="st">"CD4_T_cell"</span>, <span class="st">"CD8_T_cell"</span>, <span class="st">"Tregs"</span><span class="op">)</span></span>
<span><span class="va">myeloid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Dc_or_Mono"</span>, <span class="st">"DC"</span>, <span class="st">"Mono_or_Neu"</span>, <span class="st">"Macrophages"</span>, <span class="st">"Other_Immune"</span>, <span class="st">"Neutrophils"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">endothelial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Endothelial"</span><span class="op">)</span></span>
<span><span class="va">mesenchymal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Mesenchymal"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tissue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">endothelial</span>, <span class="va">mesenchymal</span><span class="op">)</span></span>
<span><span class="va">immune</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcells</span>, <span class="va">tcells</span>, <span class="va">myeloid</span>, <span class="st">"NK"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tumour</span>, <span class="va">tissue</span>, <span class="va">immune</span>, <span class="st">"Unidentified"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="do-p53-tumour-cells-exhibit-a-different-spatial-behaviour-compared-to-all-tumour-cells">Do p53+ tumour cells exhibit a different spatial behaviour compared
to all tumour cells?<a class="anchor" aria-label="anchor" href="#do-p53-tumour-cells-exhibit-a-different-spatial-behaviour-compared-to-all-tumour-cells"></a>
</h5>
<p>Here we examine an image highlighted in the Keren et al. 2018
manuscript where the relationship between two cell types depends on a
parent cell population. In image 6 of the Keren et al. dataset, we can
see that <em>p53+ tumour cells</em> and <em>immune cells</em> are
dispersed. However when the behaviour of <em>p53+ tumour cells</em> are
placed in the context of the spatial behaviour of its broader parent
population <em>tumour cells</em>, <em>p53+ tumour cells</em> and
<em>immune</em> would appear localised.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Lets define a new cell type vector</span></span>
<span><span class="va">kerenSPE</span><span class="op">$</span><span class="va">cellTypeNew</span> <span class="op">&lt;-</span> <span class="va">kerenSPE</span><span class="op">$</span><span class="va">cellType</span></span>
<span></span>
<span><span class="co"># Select for all cells that express higher than baseline level of p53</span></span>
<span><span class="va">p53Pos</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span><span class="op">[</span><span class="st">"p53"</span>,<span class="op">]</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">0.300460</span></span>
<span></span>
<span><span class="co"># Find p53+ tumour cells</span></span>
<span><span class="va">kerenSPE</span><span class="op">$</span><span class="va">cellTypeNew</span><span class="op">[</span><span class="va">kerenSPE</span><span class="op">$</span><span class="va">cellType</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">tumour</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Tumour"</span></span>
<span><span class="va">kerenSPE</span><span class="op">$</span><span class="va">cellTypeNew</span><span class="op">[</span><span class="va">p53Pos</span> <span class="op">&amp;</span> <span class="va">kerenSPE</span><span class="op">$</span><span class="va">cellType</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">tumour</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"p53_Tumour"</span></span>
<span></span>
<span><span class="co">#Group all immune cells under the name "Immune"</span></span>
<span></span>
<span><span class="va">kerenSPE</span><span class="op">$</span><span class="va">cellTypeNew</span><span class="op">[</span><span class="va">kerenSPE</span><span class="op">$</span><span class="va">cellType</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">immune</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Immune"</span></span>
<span></span>
<span></span>
<span><span class="co"># Plot image 6</span></span>
<span></span>
<span><span class="va">kerenSPE</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">imageID</span> <span class="op">==</span> <span class="st">"6"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cellTypeNew</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Immune"</span>, <span class="st">"Tumour"</span>, <span class="st">"p53_Tumour"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">cellTypeNew</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">cellTypeNew</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#505050"</span>, <span class="st">"#64BC46"</span>,<span class="st">"#D6D6D6"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Cell types"</span>, override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="how-do-we-quantify-this-relationship">How do we quantify this relationship?<a class="anchor" aria-label="anchor" href="#how-do-we-quantify-this-relationship"></a>
</h5>
<p>The <code>Kontextual</code> function accepts a
<code>SingleCellExperiment</code> object, or a single image, or list of
images from a <code>SingleCellExperiment</code> object, this gets passed
into the <code>cells</code> argument. The two cell types which will be
evaluated are specified in the <code>to</code> and <code>from</code>
arguments. A parent population must also be specified in the
<code>parent</code> argument, note the parent cell population must
include the <code>to</code> cell type. The argument <code>r</code> will
specify the radius which the cell relationship will be evaluated on.
<code>Kontextual</code> supports parallel processing, the number of
cores can be specified using the <code>cores</code> argument.
<code>Kontextual</code> can take a single value or multiple values for
each argument and will test all combinations of the arguments
specified.</p>
<p>We can calculate these relationships for a single radius.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p53_Kontextual</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/Kontextual.html" class="external-link">Kontextual</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  image <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  r <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  from <span class="op">=</span> <span class="st">"Immune"</span>,</span>
<span>  to <span class="op">=</span> <span class="st">"p53_Tumour"</span>,</span>
<span>  parent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"p53_Tumour"</span>, <span class="st">"Tumour"</span><span class="op">)</span>,</span>
<span>  cellType <span class="op">=</span> <span class="st">"cellTypeNew"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">p53_Kontextual</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="how-do-i-choose-a-radius">How do I choose a radius?<a class="anchor" aria-label="anchor" href="#how-do-i-choose-a-radius"></a>
</h5>
<p>The <code>kontextCurve</code> calculates the L-function value and
Kontextual values over a range of radii. While <code>kontextPlot</code>
plots these values. If the points lie above the red line (expected
pattern) then localisation is indicated for that radius, if the points
lie below the red line then dispersion is indicated. As seen in the
following plot Kontextual is able to correctly identify localisation
between p53+ tumour cells and immune cells in the example image for a
certain range of radii. The original L-function is not able to identify
localisation at any value of radii.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">curves</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/kontextCurve.html" class="external-link">kontextCurve</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  image <span class="op">=</span> <span class="st">"6"</span>,</span>
<span>  from <span class="op">=</span> <span class="st">"Immune"</span>,</span>
<span>  to <span class="op">=</span> <span class="st">"p53_Tumour"</span>,</span>
<span>  parent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"p53_Tumour"</span>, <span class="st">"Tumour"</span><span class="op">)</span>,</span>
<span>  rs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">510</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  cellType <span class="op">=</span> <span class="st">"cellTypeNew"</span>,</span>
<span>  cores <span class="op">=</span> <span class="va">nCores</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/kontextPlot.html" class="external-link">kontextPlot</a></span><span class="op">(</span><span class="va">curves</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="how-do-i-quantitatively-identify-these-function-dictated-spatial-patterns-across-all-my-images">How do I quantitatively identify these function-dictated spatial
patterns across all my images?<a class="anchor" aria-label="anchor" href="#how-do-i-quantitatively-identify-these-function-dictated-spatial-patterns-across-all-my-images"></a>
</h5>
<p>Alternatively all pairwise cell relationships and their corresponding
parents in the dataset can be tested. A data frame with all pairwise
combinations can be creating using the <code>parentCombinations</code>
function. This function takes in a vector of all the cells, as well as
all the parent vectors set up earlier. As shown below the output is a
data frame specifying the <code>to</code>, <code>from</code>, and
<code>parent</code> arguments for <code>Kontextual</code>.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get all relationships between cell types and their parents</span></span>
<span><span class="va">parentDf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/parentCombinations.html" class="external-link">parentCombinations</a></span><span class="op">(</span></span>
<span>  all <span class="op">=</span> <span class="va">all</span>,</span>
<span>  <span class="va">tumour</span>,</span>
<span>  <span class="va">bcells</span>,</span>
<span>  <span class="va">tcells</span>,</span>
<span>  <span class="va">myeloid</span>,</span>
<span>  <span class="va">endothelial</span>,</span>
<span>  <span class="va">mesenchymal</span>,</span>
<span>  <span class="va">tissue</span>,</span>
<span>  <span class="va">immune</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Rather than specifying <code>to</code>, <code>from</code>, and
<code>parent</code> in Kontextual, the output from
<code>parentCombinations</code> can be input into
<code>Kontextual</code> using the <code>parentDf</code> argument, to
examine all pairwise relationships in the dataset. This chunk will take
a significant amount of time to run (~20 minutes), for demonstration the
results have been saved and are loaded in.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Running Kontextual on all relationships across all images.</span></span>
<span><span class="va">kerenKontextual</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/Kontextual.html" class="external-link">Kontextual</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  parentDf <span class="op">=</span> <span class="va">parentDf</span>,</span>
<span>  r <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  cores <span class="op">=</span> <span class="va">nCores</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"kerenKontextual.rda"</span>, package <span class="op">=</span> <span class="st">"ScdneySpatial"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="are-these-spatial-patterns-associated-with-survival-outcomes">Are these spatial patterns associated with survival outcomes?<a class="anchor" aria-label="anchor" href="#are-these-spatial-patterns-associated-with-survival-outcomes"></a>
</h5>
<p>To examine whether the features obtained from <code>Statial</code>
are associated with patient outcomes or groupings, we can use the
<code>colTest</code> function from <code>SpicyR</code>. To understand if
survival outcomes differ significantly between 2 patient groups, specify
<code>type = "survival"</code> in <code>colTest</code>. Here we examine
which features are most associated with patient survival using the
Kontextual values as an example. To do so, survival data is extracted
from <code>kerenSPE</code> and converted into the survival object
<code>kerenSurv</code>.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extracting survival data</span></span>
<span><span class="va">survData</span> <span class="op">=</span> <span class="va">kerenSPE</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">imageID</span>, <span class="va">Survival_days_capped.</span>, <span class="va">event</span>, <span class="va">RECURRENCE_LABEL</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Creating survival vector</span></span>
<span><span class="va">kerenSurv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">survData</span><span class="op">$</span><span class="va">Survival_days_capped</span>, <span class="va">survData</span><span class="op">$</span><span class="va">event</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">kerenSurv</span><span class="op">)</span> <span class="op">=</span> <span class="va">survData</span><span class="op">$</span><span class="va">imageID</span></span></code></pre></div>
<p>In addition to this, the Kontextual results must be converted from a
<code>data.frame</code> to a wide <code>matrix</code>, this can be done
using <code>prepMatrix</code>. Note, to extract the original L-function
values, specify <code>column = "original"</code> in
<code>prepMatrix</code>.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Converting Kontextual result into data matrix</span></span>
<span><span class="va">kontextMat</span> <span class="op">=</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/prepMatrix.html" class="external-link">prepMatrix</a></span><span class="op">(</span><span class="va">kerenKontextual</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ensuring rownames of kontextMat match up with rownames of the survival vector </span></span>
<span><span class="va">kontextMat</span> <span class="op">=</span> <span class="va">kontextMat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">kerenSurv</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Replace NAs with 0</span></span>
<span><span class="va">kontextMat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">kontextMat</span> <span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>Finally, both the Kontextual matrix and survival object are passed
into <code>colTest</code>, with <code>type = "survival"</code> to obtain
the survival results.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Running survival analysis</span></span>
<span><span class="va">survivalResults</span> <span class="op">=</span> <span class="fu">spicyR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/spicyR/man/colTest.html" class="external-link">colTest</a></span><span class="op">(</span><span class="va">kontextMat</span>, <span class="va">kerenSurv</span>, type <span class="op">=</span> <span class="st">"survival"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">survivalResults</span><span class="op">)</span></span></code></pre></div>
<p>As we can see from the results
<code>CD8_T_cell__Keratin_Tumour__immune</code> is the most significant
pairwise relationship which contributes to patient survival. That is the
relationship between CD8 T cells and Keratin+ Tumour cells, relative to
the parent population of all immune cells. We can see that there is a
negative coefficient associated with this relationship, which tells us a
decrease in localisation of CD8_T_cell and Keratin+ Tumour leads to
poorer survival outcomes for patients.</p>
<p>We can visualise this association sing a Kaplan-Meier curve. We must
first extract the Kontextual values of this relationship across all
images. Next we determine if CD8 T cells and Keratin+ Tumours are
relatively attracted or avoiding in each image, by comparing the
Kontextual value in each image to the median Kontextual value. Finally
we plot the Kaplan-Meier curve using the <code>ggsurvfit</code>
package.</p>
<p>As shown below, when CD8 T cells and Keratin+ Tumours are relatively
more dispersed to one another, patients tend to have worse survival
outcomes.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Selecting most significant relationship</span></span>
<span><span class="va">survRelationship</span> <span class="op">=</span> <span class="va">kontextMat</span><span class="op">[[</span><span class="st">"CD8_T_cell__Keratin_Tumour__immune"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">survRelationship</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">survRelationship</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">survRelationship</span><span class="op">)</span>, <span class="st">"Localised"</span>, <span class="st">"Dispersed"</span><span class="op">)</span></span>
<span>    </span>
<span><span class="co"># Plotting Kaplan-Meier curve</span></span>
<span><span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/survfit2.html" class="external-link">survfit2</a></span><span class="op">(</span><span class="va">kerenSurv</span> <span class="op">~</span> <span class="va">survRelationship</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/ggsurvfit.html" class="external-link">ggsurvfit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/add_pvalue.html" class="external-link">add_pvalue</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"CD8_T_cell__Keratin_Tumour__immune"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level4">
<h4 class="tabset" id="are-there-changes-in-cell-states-associated-with-cell-localisation">Are there changes in cell states associated with cell
localisation?<a class="anchor" aria-label="anchor" href="#are-there-changes-in-cell-states-associated-with-cell-localisation"></a>
</h4>
<p>Changes in cell phenotype can be analytically framed as the change in
abundance of a gene or protein within a particular cell type. We can
analytically determine whether continuous changes occur to a cell’s
proteomic or transcriptomic signature as changes occur in its spatial
proximity to another cell type. In the figures below we see the
expression of a marker increased in cell type A as it grows closer in
spatial proximity to cell type B. This can then be quantified with a
scatterplot to determine statistical significance. In the next section
of this workshop, we will be exploring the analytical functionalities of
Statial which can uncover these continuous changes in cell state.</p>
<p><img src="images/ctsCombined.jpg" alt="ctsCombined" style="border: 0px"></p>
<div class="section level5">
<h5 id="how-do-we-identify-specific-marker-changes-when-distinct-cell-types-increase-or-decrease-in-spatial-proximity">How do we identify specific marker changes when distinct cell types
increase or decrease in spatial proximity?<a class="anchor" aria-label="anchor" href="#how-do-we-identify-specific-marker-changes-when-distinct-cell-types-increase-or-decrease-in-spatial-proximity"></a>
</h5>
<p>The first step in analysing these changes is to calculate the spatial
proximity (<code>getDistances</code>) and abundance
(<code>getAbundances</code>) of each cell to every cell type. These
values will then be stored in the <code>reducedDims</code> slot of the
<code>SpatialExperiment</code> object under the names
<code>distances</code> and <code>abundances</code> respectively.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kerenSPE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/getDistances.html" class="external-link">getDistances</a></span><span class="op">(</span><span class="va">kerenSPE</span>,</span>
<span>                    maxDist <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kerenSPE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/getAbundances.html" class="external-link">getAbundances</a></span><span class="op">(</span><span class="va">kerenSPE</span>,</span>
<span>                     r <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">kerenSPE</span>, <span class="st">"abundances"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">kerenSPE</span>, <span class="st">"abundances"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>First, let’s examine the same effect observed earlier with
Kontextual. To avoid redefining cell types we’ll examine the distance
between p53-positive tumour cells and macrophages in the context of
total keratin/tumour cells for image 6.</p>
<p>Statial provides two main functions to assess this relationship -
<code>calcStateChanges</code> and <code>plotStateChanges</code>. We can
use <code>calcStateChanges</code> to examine the relationship between 2
cell types for 1 marker in a specific image. Similar to
<code>Kontextual</code>, we can specify the two cell types with the
<code>to</code> and <code>from</code> arguments, and the marker of
interest with the <code>marker</code> argument. We can appreciate that
the <code>fdr</code> statistic for this relationship is significant, and
with a negative <code>coef</code>, or coefficient value, indicating that
the expression of p53 in keratin/tumour cells decreases as distance from
macrophages increases.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stateChanges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/calcStateChanges.html" class="external-link">calcStateChanges</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"distances"</span>,</span>
<span>  image <span class="op">=</span> <span class="st">"6"</span>,</span>
<span>  from <span class="op">=</span> <span class="st">"Keratin_Tumour"</span>,</span>
<span>  to <span class="op">=</span> <span class="st">"Macrophages"</span>,</span>
<span>  marker <span class="op">=</span> <span class="st">"p53"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stateChanges</span></span></code></pre></div>
<p>Statial provides a convenient function for visualising this
relationship - <code>plotStateChanges</code>. Similar to
<code>Kontextual</code> and <code>calcStateChanges</code>, we can
specify the cell types to be evaluated with the <code>to</code> and
<code>from</code> arguments and the marker of interest with
<code>marker</code>.</p>
<p>Through this analysis, we can observe that keratin/tumour cells
closer to a group of macrophages tend to have higher expression of p53,
as observed in the first graph. This relationship is quantified with the
second graph, showing an overall decrease of p53 expression in
keratin/tumour cells as distance to macrophages increase.</p>
<p>These results allow us to essentially arrive at the same result as
Kontextual, which calculated a localisation between p53+ keratin/tumour
cells and macrophages in the wider context of keratin/tumour cells.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/plotStateChanges.html" class="external-link">plotStateChanges</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"distances"</span>,</span>
<span>  image <span class="op">=</span> <span class="st">"6"</span>,</span>
<span>  from <span class="op">=</span> <span class="st">"Keratin_Tumour"</span>,</span>
<span>  to <span class="op">=</span> <span class="st">"Macrophages"</span>,</span>
<span>  marker <span class="op">=</span> <span class="st">"p53"</span>,</span>
<span>  size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  shape <span class="op">=</span> <span class="fl">19</span>,</span>
<span>  interactive <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  plotModelFit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">image</span></span>
<span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">scatter</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"p53 expression in Keratin_Tumour"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Distance of Keratin_Tumour to Macrophages"</span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Question</strong></p>
<ol style="list-style-type: decimal">
<li>What information does this form of analysis provide that Kontextual
does not?</li>
<li>Is this observation of localisation consistent across images?</li>
<li>Can you find an interaction where the coefficient is positive? i.e.
marker expression in the <code>to</code> cell type rises as distances
increases from the <code>from</code> cell type.</li>
</ol>
</div>
</div>
<div class="section level5">
<h5 id="can-we-repeat-this-analysis-across-all-images-to-identify-global-relationships">Can we repeat this analysis across all images to identify global
relationships?<a class="anchor" aria-label="anchor" href="#can-we-repeat-this-analysis-across-all-images-to-identify-global-relationships"></a>
</h5>
<p>Beyond looking at single cell-to-cell interactions for a single
image, we can also look at all interactions across all images. The
<code>calcStateChanges</code> function provided by Statial can be
expanded for this exact purpose - by not specifying cell types, a
marker, or an image, <code>calcStateChanges</code> will examine the most
significant correlations between distance and marker expression across
the entire dataset. Here, we’ve calculated all state changes across all
images in case you would like to have a play, but first we’ll be taking
a closer examination at the most significant interactions found within
image 6 of the Keren et al. dataset.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stateChanges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/calcStateChanges.html" class="external-link">calcStateChanges</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"distances"</span>,</span>
<span>  minCells <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stateChanges</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">imageID</span> <span class="op">==</span> <span class="fl">6</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>In image 6, the majority of the top 10 most significant interactions
occur between keratin/tumour cells and an immune population, and many of
these interactions appear to involve the HLA class I ligand.</p>
<p>We can examine some of these interactions further with the
<code>plotStateChanges</code> function. Taking a closer examination of
the relationship between macrophages and keratin/tumour HLA class I
expression, the plot below shows us a clear visual correlation - as
macrophage density increases, keratin/tumour cells increase their
expression HLA class I.</p>
<p>Biologically, HLA Class I is a ligand which exists on all nucleated
cells, tasked with presenting internal cell antigens for recognition by
the immune system, marking aberrant cells for destruction by either CD8+
T cells or NK cells.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/plotStateChanges.html" class="external-link">plotStateChanges</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"distances"</span>,</span>
<span>  image <span class="op">=</span> <span class="st">"6"</span>,</span>
<span>  from <span class="op">=</span> <span class="st">"Keratin_Tumour"</span>,</span>
<span>  to <span class="op">=</span> <span class="st">"Macrophages"</span>,</span>
<span>  marker <span class="op">=</span> <span class="st">"HLA_Class_1"</span>,</span>
<span>  size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  shape <span class="op">=</span> <span class="fl">19</span>,</span>
<span>  interactive <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  plotModelFit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">image</span></span>
<span></span>
<span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">scatter</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"HLA_Class_1 expression in Keratin_Tumour"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Distance of Keratin_Tumour to Macrophages"</span><span class="op">)</span></span></code></pre></div>
<p>Now, we can take a look at the top 10 most significant results across
all images.</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stateChanges</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>Immediately, we can appreciate that a couple of interactions appear a
bit strange. One of the most significant interactions occurs between B
cells and CD4 T cells, where CD4 T cells are found to increase in CD20
expression when in close proximity to B cells. Biologically, CD20 is a
highly specific ligand for B cells, and under healthy circumstances are
usually not expressed in T cells.</p>
<p>Could this potentially be an artefact of
<code>calcStateChanges</code>? We can examine the image through the
<code>plotStateChanges</code> function, where we indeed observe an
apparent localisation between B cells and T cells.</p>
<div class="question">
<p><strong>Question</strong></p>
<ol style="list-style-type: decimal">
<li><p>Are there any other interactions here that you think might not
make biological sense?<br></p></li>
<li><p>Does the relationship between T cell CD20 expression and B cell
proximity occur across images?<br></p></li>
<li>
<p>Why are the majority of most significant interactions occurring
in image 35?</p>
<p>HINT: Configure the parameters of <code>plotStateChanges</code> to
examine some these other significant interactions. Do they look like
artefacts?</p>
</li>
</ol>
</div>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/plotStateChanges.html" class="external-link">plotStateChanges</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"distances"</span>,</span>
<span>  image <span class="op">=</span> <span class="st">"35"</span>,</span>
<span>  from <span class="op">=</span> <span class="st">"CD4_T_cell"</span>,</span>
<span>  to <span class="op">=</span> <span class="st">"B_cell"</span>,</span>
<span>  marker <span class="op">=</span> <span class="st">"CD20"</span>,</span>
<span>  size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  shape <span class="op">=</span> <span class="fl">19</span>,</span>
<span>  interactive <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  plotModelFit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">image</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"CD20 expression in CD4_T_cell"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Distance of B_cell to CD4_T_cell"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">scatter</span></span></code></pre></div>
<p>So why are T cells expressing CD20? This brings us to a key
limitation of cell segmentation.</p>
</div>
<div class="section level5">
<h5 id="how-do-we-deal-with-lateral-cell-spill-over">How do we deal with lateral cell spill over?<a class="anchor" aria-label="anchor" href="#how-do-we-deal-with-lateral-cell-spill-over"></a>
</h5>
<p>Contamination, or more specifically known as lateral marker spill
over, is an issue that results in a cell’s marker expressions being
wrongly attributed to another adjacent cell. This issue arises from
incorrect segmentation where components of one cell are wrongly
determined as belonging to another cell. Alternatively, this issue can
arise when antibodies used to tag and measure marker expressions do not
latch on properly to a cell of interest, thereby resulting in residual
markers being wrongly assigned as belonging to a cell near the intended
target cell. It is important that we either correct or account for this
incorrect attribution of markers in our modelling process. This is
critical in understanding whether significant cell-cell interactions
detected are an artifact of technical measurement errors driven by spill
over or are real biological changes that represent a shift in a cell’s
state.</p>
<p><img src="images/Contamination.png" alt="Contamination" style="width: 4in; border: 0px"></p>
<p>To circumvent this problem, <code>Statial</code> provides a function
that predicts the probability that a cell is any particular cell type -
<code>calcContamination</code>. <code>calcContamination</code> returns a
dataframe of probabilities demarcating the chance of a cell being any
particular cell type. This dataframe is stored under
<code>contaminations</code> in the <code>reducedDim</code> slot of the
<code>SpatialExperiment</code> object. It also provides the
<code>rfMainCellProb</code> column, which provides the probability that
a cell is indeed the cell type it has been designated. E.g. For a cell
designated as a CD8+ T cell, rfMainCellProb could give a 80% chance that
the cell is indeed CD8+ T cell, due to contamination.</p>
<p>We can then introduce these probabilities as covariates into our
linear model by setting <code>contamination = TRUE</code> as a parameter
in our <code>calcStateChanges</code> function. However, this is not a
perfect solution for the issue of contamination. As we can see, despite
factoring in contamination into our linear model, the correlation
between B cell density and CD20 expression in CD4+ T cells remains one
of the most significant interactions in our model.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kerenSPE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/calcContamination.html" class="external-link">calcContamination</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stateChangesCorrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/calcStateChanges.html" class="external-link">calcStateChanges</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"distances"</span>,</span>
<span>  minCells <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  contamination <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stateChangesCorrected</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<p>However, this does not mean factoring in contamination into our
linear model was ineffective. In general, cell type specific markers
such as CD68, CD45, and CD20 should not change in cells they are not
specific to. Therefore, relationships detected to be significant
involving these cell type markers are likely false positives and will be
treated as such for the purposes of evaluation.</p>
<p>Plotting the relationship between false positives and true positives,
we’d expect the contamination correction to be greatest in relationships
which are detected to be more significant.</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cellTypeMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CD3"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8"</span>, <span class="st">"CD56"</span>, <span class="st">"CD11c"</span>, <span class="st">"CD68"</span>, <span class="st">"CD45"</span>, <span class="st">"CD20"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">values</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">values</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"None"</span>, <span class="st">"Corrected"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>TP <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">stateChanges</span><span class="op">$</span><span class="va">marker</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cellTypeMarkers</span><span class="op">)</span>, FP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="op">!</span><span class="va">stateChanges</span><span class="op">$</span><span class="va">marker</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cellTypeMarkers</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"None"</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>TP <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">stateChangesCorrected</span><span class="op">$</span><span class="va">marker</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cellTypeMarkers</span><span class="op">)</span>, FP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="op">!</span><span class="va">stateChangesCorrected</span><span class="op">$</span><span class="va">marker</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cellTypeMarkers</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"Corrected"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">TP</span>, y <span class="op">=</span> <span class="va">FP</span>, colour <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Cell state marker"</span>, x <span class="op">=</span> <span class="st">"Cell type marker"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">values</span><span class="op">)</span></span></code></pre></div>
<p>Here, we zoom in on the ROC curve where the top 100 lowest p values
occur, where we indeed see more true positives than false positives with
contamination correction.</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">TP</span>, y <span class="op">=</span> <span class="va">FP</span>, colour <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1000</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Cell state marker"</span>, x <span class="op">=</span> <span class="st">"Cell type marker"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">values</span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Question</strong></p>
<ol style="list-style-type: decimal">
<li>What can we conclude from the above ROC graphs?</li>
</ol>
</div>
</div>
<div class="section level5">
<h5 id="are-these-cell-type---marker-relationships-predictive-or-survival-outcomes">Are these cell type - marker relationships predictive or survival
outcomes?<a class="anchor" aria-label="anchor" href="#are-these-cell-type---marker-relationships-predictive-or-survival-outcomes"></a>
</h5>
<p>Similiar to <code>Kontextual</code>, we can run a similar survival
analysis using our state changes results. Here, <code>prepMatrix</code>
extracts the coefficients, or the <code>coef</code> column of
<code>stateChanges</code> by default. To use the t values instead,
specify <code>column = "tval"</code> in the <code>prepMatrix</code>
function.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Preparing features for Statial</span></span>
<span><span class="va">stateMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/prepMatrix.html" class="external-link">prepMatrix</a></span><span class="op">(</span><span class="va">stateChanges</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ensuring rownames of stateMat match up with rownames of the survival vector</span></span>
<span><span class="va">stateMat</span> <span class="op">&lt;-</span> <span class="va">stateMat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">kerenSurv</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Remove some very small values</span></span>
<span><span class="va">stateMat</span> <span class="op">&lt;-</span> <span class="va">stateMat</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">stateMat</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">0.0001</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">.8</span><span class="op">]</span></span>
<span></span>
<span><span class="va">survivalResults</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spicyR/man/colTest.html" class="external-link">colTest</a></span><span class="op">(</span><span class="va">stateMat</span>, <span class="va">kerenSurv</span>, type <span class="op">=</span> <span class="st">"survival"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">survivalResults</span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Question</strong></p>
<ol style="list-style-type: decimal">
<li>Are the survival results the same for both the distance and
abundance metrics?</li>
<li>Do these survival results change with contamination correction?</li>
<li>Why might the survival results look the same/different between
distance and abundance?</li>
</ol>
</div>
<p>For our state changes results,
<code>Macrophages__CD4_T_cell__CD138</code> is the most significant
pairwise relationship which contributes to patient survival. That is,
the relationship between CD138 expression in macrophages as their
spatial proximity to CD4 T cells change. The positive coeffcient
associated with this relationship tells us that lower CD138 expression
in macrophages nearby CD4 T cells lead to poorer survival outcomes for
patients.</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Selecting the most significant relationship</span></span>
<span><span class="va">survRelationship</span> <span class="op">=</span> <span class="va">stateMat</span><span class="op">[[</span><span class="st">"Macrophages__CD4_T_cell__CD138"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">survRelationship</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">survRelationship</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">survRelationship</span><span class="op">)</span>, <span class="st">"Higher expressed in close cells"</span>, <span class="st">"Lower expressed in close cells"</span><span class="op">)</span></span>
<span>    </span>
<span><span class="co"># Plotting Kaplan-Meier curve</span></span>
<span><span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/survfit2.html" class="external-link">survfit2</a></span><span class="op">(</span><span class="va">kerenSurv</span> <span class="op">~</span> <span class="va">survRelationship</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/ggsurvfit.html" class="external-link">ggsurvfit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="http://www.danieldsjoberg.com/ggsurvfit/reference/add_pvalue.html" class="external-link">add_pvalue</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Macrophages__CD4_T_cell__CD138"</span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Question</strong></p>
<ol style="list-style-type: decimal">
<li>How should these coefficients be interpreted?</li>
<li>Do any of these relationships makes sense?</li>
<li>Could you visualise representative images?</li>
</ol>
</div>
</div>
</div>
<div class="section level4">
<h4 class="tabset" id="how-do-we-generate-a-molecular-representation-for-each-individual">How do we generate a molecular representation for
each individual?<a class="anchor" aria-label="anchor" href="#how-do-we-generate-a-molecular-representation-for-each-individual"></a>
</h4>
<p>The next section of this workshop will be dedicated to
<code>scFeatures</code> - a straightforward package for generating a
suite of molecular representations regarding a patient, taking a matrix
of <code>proteins x cells</code> as input. The molecular representation
is interpretable and hence facilitates downstream analysis of the
individual. In general, <code>scFeatures</code> generates features
across six categories representing different molecular views of cellular
characteristics. These include:</p>
<ol style="list-style-type: lower-roman">
<li>cell type proportions</li>
<li>cell type specific gene expressions</li>
<li>cell type specific pathway expressions</li>
<li>cell type specific cell-cell interaction (CCI) scores</li>
<li>overall aggregated gene expressions</li>
<li>spatial metrics</li>
</ol>
<p>The different types of features constructed enable a more
comprehensive multi-view understanding of each individual from a matrix
of <code>spot x cells</code>. By default, the function will generate a
total of 13 different types of features (feature_types) shown below and
store them in a list. All generated feature types are stored in a matrix
of <code>samples x features</code>.</p>
<pre><code><span><span class="co">##  [1] "proportion_raw"       "proportion_logit"     "proportion_ratio"    </span></span>
<span><span class="co">##  [4] "gene_mean_celltype"   "gene_prop_celltype"   "gene_cor_celltype"   </span></span>
<span><span class="co">##  [7] "gene_mean_bulk"       "gene_prop_bulk"       "gene_cor_bulk"       </span></span>
<span><span class="co">## [10] "L_stats"              "celltype_interaction" "morans_I"            </span></span>
<span><span class="co">## [13] "nn_correlation"</span></span></code></pre>
<p>There are different ways you can use <code>scFeatures</code> to
generate molecular representations for individuals and it requires the
following information for spatial data.</p>
<ul>
<li>data,</li>
<li>sample,</li>
<li>X coordinates,</li>
<li>Y coordinates,</li>
<li>feature_types, and</li>
<li>type</li>
</ul>
<p>There are a total of 13 different types of features (feature_types)
that you can choose to generate. The argument type refers the type of
input data we have. This is either <code>scrna</code> (single-cell
RNA-sequencing data), <code>spatial_p</code> (spatial proteomics data),
or <code>spatial_t</code> (single cell spatial data).</p>
<p>Suppose that we are interested in determining the proportion of each
cell type in each individual within each region. It is necessary to
specify <code>type = spatial_p</code> to reflect that we have spatial
proteomics data and <code>feature_types = proportion_raw</code> to
indicate we intend to calculate cell type proportion for each of the
region-specific sub-cell types.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">kerenSPE</span>, <span class="st">"intensities"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="va">kerenSPE</span><span class="op">$</span><span class="va">imageID</span></span>
<span><span class="va">celltype</span> <span class="op">&lt;-</span> <span class="va">kerenSPE</span><span class="op">$</span><span class="va">cellType</span></span>
<span><span class="va">spatialCoords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">scfeatures_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/scFeatures/reference/scFeatures.html" class="external-link">scFeatures</a></span><span class="op">(</span><span class="va">matrix</span>, type <span class="op">=</span> <span class="st">"spatial_p"</span>,</span>
<span>                                sample <span class="op">=</span> <span class="va">sample</span>, celltype <span class="op">=</span> <span class="va">celltype</span>, spatialCoords <span class="op">=</span> <span class="va">spatialCoords</span>,</span>
<span>                                ncores <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"scfeaturesResult.rda"</span>, package <span class="op">=</span> <span class="st">"ScdneySpatial"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">scfeatures_result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>The output of scFeatures, <code>scfeatures_result</code>, is a list
of 13 dataframes, which each represent a different molecular feature of
a patient. Below, we give an example visualisation of the raw cell type
proportions for each patient.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">feature</span> <span class="op">&lt;-</span> <span class="va">scfeatures_result</span><span class="op">$</span><span class="va">proportion_raw</span></span>
<span></span>
<span><span class="va">feature</span><span class="op">$</span><span class="va">patient</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">feature</span><span class="op">)</span>, <span class="st">"_cond_"</span><span class="op">)</span>, <span class="va">`[`</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">feature</span><span class="op">$</span><span class="va">condition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">feature</span><span class="op">)</span>, <span class="st">"_cond_"</span><span class="op">)</span>, <span class="va">`[`</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/reshape/man/melt-24.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">feature</span>, id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"patient"</span>, <span class="st">"condition"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">feature</span> , <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">patient</span> , y <span class="op">=</span> <span class="va">value</span> , fill <span class="op">=</span> <span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>   </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, vjust <span class="op">=</span> <span class="fl">1</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Proportion raw feature"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 class="tabset" id="can-i-identify-molecular-signatures-for-localised-lesion-or-tumour-regions-in-my-data">Can I identify molecular signatures for localised
lesion or tumour regions in my data?<a class="anchor" aria-label="anchor" href="#can-i-identify-molecular-signatures-for-localised-lesion-or-tumour-regions-in-my-data"></a>
</h4>
<p>We can cluster areas with similar spatial interactions to identify
regions using the <code>lisaClust</code> package on Bioconductor. Here
we set <code>k = 5</code> to identify 5 regions. For the Keren et
al. dataset, we’re effectively aiming to separate out 3 regions: -
Non-tumour regions - Tumour regions - Tumour-immune interaction
regions.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">51773</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preparing features for lisaClust</span></span>
<span><span class="va">kerenSPE</span> <span class="op">&lt;-</span> <span class="fu">lisaClust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lisaClust/man/lisaClust.html" class="external-link">lisaClust</a></span><span class="op">(</span><span class="va">kerenSPE</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>So what are some ways I can check that my region clustering has
worked effectively? One way we can do this is to use the
<code>hatchingPlot</code> function to visualise the regions identified
by lisaClust.</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use hatching to visualise regions and cell types.</span></span>
<span><span class="fu">lisaClust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lisaClust/man/hatchingPlot.html" class="external-link">hatchingPlot</a></span><span class="op">(</span><span class="va">kerenSPE</span>,</span>
<span>  useImages <span class="op">=</span> <span class="st">"5"</span>,</span>
<span>  line.spacing <span class="op">=</span> <span class="fl">41</span>, <span class="co"># spacing of lines</span></span>
<span>  nbp <span class="op">=</span> <span class="fl">100</span> <span class="co"># smoothness of lines</span></span>
<span><span class="op">)</span> </span></code></pre></div>
<p>We can appreciate that the regions have separated out nicely for
image 5, with region 1 clearly being a tumour region, region 5 a
non-tumour region, and region 3 being the tumour-immune interaction
region.</p>
<p>We can also use the <code>regionMap</code> function to get a more
quantitative determination of what each region represents, to look at
which cell types are encountered in which regions.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/lisaClust/man/regionMap.html" class="external-link">regionMap</a></span><span class="op">(</span><span class="va">kerenSPE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="changes-in-marker-means">Changes in marker means<a class="anchor" aria-label="anchor" href="#changes-in-marker-means"></a>
</h4>
<p><code>Statial</code> provides functionality to identify the average
marker expression of a given cell type in a given region, using the
<code>getMarkerMeans</code> function. Similar to the analysis above,
these features can also be used for survival analysis.</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cellTypeRegionMeans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/getMarkerMeans.html" class="external-link">getMarkerMeans</a></span><span class="op">(</span><span class="va">kerenSPE</span>,</span>
<span>                              imageID <span class="op">=</span> <span class="st">"imageID"</span>,</span>
<span>                              cellType <span class="op">=</span> <span class="st">"cellType"</span>,</span>
<span>                              region <span class="op">=</span> <span class="st">"region"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">survivalResults</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/spicyR/man/colTest.html" class="external-link">colTest</a></span><span class="op">(</span><span class="va">cellTypeRegionMeans</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">kerenSurv</span><span class="op">)</span>,<span class="op">]</span>, <span class="va">kerenSurv</span>, type <span class="op">=</span> <span class="st">"survival"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">survivalResults</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="module-7-patient-classification">Module 7: Patient classification<a class="anchor" aria-label="anchor" href="#module-7-patient-classification"></a>
</h3>
<p>Finally we demonstrate how we can use the Bioconductor package
<code>ClassifyR</code> to perform patient classification with the
features generated from <code>Statial</code> and
<code>scFeatures</code>. In addition to this, we also calculate cell
type proportions and region proportions using the <code>getProp</code>
function in <code>spicyR</code>. Here we perform 5 fold cross validation
with 20 repeats, using a CoxPH model for survival classification.</p>
<p>To prepare our metrics for classification, first we must convert our
dataframes into matrix format. This can be accomplished, as we did
earlier, with the <code>prepMatrix</code> function of
<code>Statial</code>. As we generated matrices for
<code>Kontextual</code> and the distance metric of
<code>SpatioMark</code> earlier, we will now be generating matrices for
the <code>SpatioMark</code> corrected distance metric, and the abundance
metrics.</p>
<p>We can also prepare a metric for region proportions, to look at
whether the percentage of area each region occupies in an image is
capable of predicting survival.</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Distances Corrected Matrix</span></span>
<span><span class="va">stateMatCorDist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/prepMatrix.html" class="external-link">prepMatrix</a></span><span class="op">(</span><span class="va">stateChangesCorrected</span><span class="op">)</span></span>
<span><span class="va">stateMatCorDist</span> <span class="op">&lt;-</span> <span class="va">stateMatCorDist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">kerenSurv</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">stateMatCorDist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">stateMatCorDist</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="co"># Remove some very small values</span></span>
<span><span class="va">stateMatCorDist</span> <span class="op">&lt;-</span> <span class="va">stateMatCorDist</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">stateMatCorDist</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">0.0001</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">.8</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">kerenSPE</span>, <span class="st">"abundances"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">kerenSPE</span>, <span class="st">"abundances"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="co">## Abundances</span></span>
<span><span class="va">stateChangesAbund</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/calcStateChanges.html" class="external-link">calcStateChanges</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"abundances"</span>,</span>
<span>  minCells <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stateMatAbund</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/prepMatrix.html" class="external-link">prepMatrix</a></span><span class="op">(</span><span class="va">stateChangesAbund</span><span class="op">)</span></span>
<span><span class="va">stateMatAbund</span> <span class="op">&lt;-</span> <span class="va">stateMatAbund</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">kerenSurv</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">stateMatAbund</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">stateMatAbund</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="co"># Remove some very small values</span></span>
<span><span class="va">stateMatAbund</span> <span class="op">&lt;-</span> <span class="va">stateMatAbund</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">stateMatAbund</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">0.0001</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">.8</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Abundances Corrected</span></span>
<span><span class="va">stateChangesCorrectedAbund</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/calcStateChanges.html" class="external-link">calcStateChanges</a></span><span class="op">(</span></span>
<span>  cells <span class="op">=</span> <span class="va">kerenSPE</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"abundances"</span>,</span>
<span>  minCells <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  contamination <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stateMatCorAbund</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sydneybiox.github.io/Statial/reference/prepMatrix.html" class="external-link">prepMatrix</a></span><span class="op">(</span><span class="va">stateChangesCorrectedAbund</span><span class="op">)</span></span>
<span><span class="va">stateMatCorAbund</span> <span class="op">&lt;-</span> <span class="va">stateMatCorAbund</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">kerenSurv</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">stateMatCorAbund</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">stateMatCorAbund</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="co"># Remove some very small values</span></span>
<span><span class="va">stateMatCorAbund</span> <span class="op">&lt;-</span> <span class="va">stateMatCorAbund</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">stateMatCorAbund</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">0.0001</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">.8</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Region proportions</span></span>
<span><span class="va">regionProp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spicyR/man/getProp.html" class="external-link">getProp</a></span><span class="op">(</span><span class="va">kerenSPE</span>, </span>
<span>                       feature <span class="op">=</span> <span class="st">"region"</span>,</span>
<span>                       imageID <span class="op">=</span> <span class="st">"imageID"</span><span class="op">)</span></span></code></pre></div>
<p>Then we compile these matrices into a list. <code>scFeatures</code>
conveniently provides all its metrics as part of a list of matrices
already, allowing us to easily combine our <code>Statial</code> metrics
with <code>scFeatures</code> into 1 list of matrices. We then input this
list into the <code>crossValidate</code> function of
<code>ClassifyR</code>, specifying our survival object created earlier,
and 5 folds of cross validation with 20 repeats. We will also be using a
feature selection algorithm selecting for 10 features for each
metric.</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">statialFeatureList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>`SpatioMark Distances` <span class="op">=</span> <span class="va">stateMat</span>,</span>
<span>                           `SpatioMark Corrected Distances` <span class="op">=</span> <span class="va">stateMatCorDist</span>,</span>
<span>                           `SpatioMark Abundances` <span class="op">=</span> <span class="va">stateMatAbund</span>,</span>
<span>                           `SpatioMark Corrected Abundances` <span class="op">=</span> <span class="va">stateMatCorAbund</span>,</span>
<span>                           `Kontextual` <span class="op">=</span> <span class="va">kontextMat</span>,</span>
<span>                           `Region Marker Means` <span class="op">=</span> <span class="va">cellTypeRegionMeans</span>,</span>
<span>                           `Region Proportions` <span class="op">=</span> <span class="va">regionProp</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">51773</span><span class="op">)</span></span>
<span></span>
<span><span class="va">featureList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">statialFeatureList</span>, <span class="va">scfeatures_result</span><span class="op">)</span></span>
<span><span class="va">featureList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">featureList</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">kerenSurv</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kerenCV</span> <span class="op">=</span> <span class="fu"><a href="https://sydneybiox.github.io/ClassifyR/reference/crossValidate.html" class="external-link">crossValidate</a></span><span class="op">(</span></span>
<span>  measurements <span class="op">=</span> <span class="va">featureList</span>,</span>
<span>  outcome <span class="op">=</span> <span class="va">kerenSurv</span>,</span>
<span>  classifier <span class="op">=</span> <span class="st">"CoxPH"</span>,</span>
<span>  selectionMethod  <span class="op">=</span> <span class="st">"CoxPH"</span>,</span>
<span>  nFolds <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  nFeatures <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  nRepeats <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  nCores <span class="op">=</span> <span class="va">nCores</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"featureList.rda"</span>, package <span class="op">=</span> <span class="st">"ScdneySpatial"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"kerenCV.rda"</span>, package <span class="op">=</span> <span class="st">"ScdneySpatial"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next, we use the <code>performancePlot</code> function to assess the
C-index from each repeat of the 5-fold cross-validation.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://sydneybiox.github.io/ClassifyR/reference/performancePlot.html" class="external-link">performancePlot</a></span><span class="op">(</span><span class="va">kerenCV</span>,</span>
<span>  characteristicsList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Assay Name"</span><span class="op">)</span>,</span>
<span>  orderingList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Assay Name"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">statialFeatureList</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">scfeatures_result</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, vjust <span class="op">=</span> <span class="fl">1</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">5.5</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">5.5</span>, xmax <span class="op">=</span> <span class="fl">7.5</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"yellow"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">7.5</span>, xmax <span class="op">=</span> <span class="fl">16.5</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">16.5</span>, xmax <span class="op">=</span> <span class="fl">21</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"green"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p>Unfortunately, our spatial metrics did not outperform some of the
simpler metrics generated by scFeatures, particularly
<code>gene_mean_bulk</code>, which simply produces a matrix describing
the average gene expression of each marker in each patient. To examine
another variable which might be of interest, we used recurrence as
another outcome to determine whether our spatial metrics could uncover
signal.</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcome</span> <span class="op">&lt;-</span> <span class="va">survData</span><span class="op">$</span><span class="va">RECURRENCE_LABEL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">survData</span><span class="op">$</span><span class="va">imageID</span></span>
<span></span>
<span><span class="va">outcome</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span></span>
<span></span>
<span><span class="va">featureList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">featureList</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kerenCV_recurrence</span> <span class="op">=</span> <span class="fu"><a href="https://sydneybiox.github.io/ClassifyR/reference/crossValidate.html" class="external-link">crossValidate</a></span><span class="op">(</span></span>
<span>  measurements <span class="op">=</span> <span class="va">featureList</span>,</span>
<span>  outcome <span class="op">=</span> <span class="va">outcome</span>,</span>
<span>  classifier <span class="op">=</span> <span class="st">"elasticNetGLM"</span>,</span>
<span>  selectionMethod <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>  nFolds <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  nFeatures <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  nRepeats <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  nCores <span class="op">=</span> <span class="va">nCores</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Again, using <code>performancePlot</code>, this time for recurrence,
we found better performance in select spatial metrics.</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"recurrenceCV.rda"</span>, package <span class="op">=</span> <span class="st">"ScdneySpatial"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://sydneybiox.github.io/ClassifyR/reference/performancePlot.html" class="external-link">performancePlot</a></span><span class="op">(</span><span class="va">kerenCV_recurrence</span>,</span>
<span>  characteristicsList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Assay Name"</span><span class="op">)</span>,</span>
<span>  orderingList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Assay Name"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">statialFeatureList</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">scfeatures_result</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, vjust <span class="op">=</span> <span class="fl">1</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">0</span>, xmax <span class="op">=</span> <span class="fl">5.5</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">5.5</span>, xmax <span class="op">=</span> <span class="fl">7.5</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"yellow"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">7.5</span>, xmax <span class="op">=</span> <span class="fl">16.5</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">16.5</span>, xmax <span class="op">=</span> <span class="fl">21</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"green"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<div class="question">
<p><strong>Questions</strong></p>
<ol style="list-style-type: decimal">
<li>Discuss among your table why spatial metrics might perform better
for recurrence compared to survival.</li>
</ol>
</div>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Farhan Ameen, Alex Qin, Nick Robertson, Shila Ghazanfar, Ellis Patrick.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>

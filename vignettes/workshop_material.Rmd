---
title: "Unlocking single cell spatial omics analyses with scdney"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Unlocking spatial omics analysis with scdney}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{html}
<style>
.question {
  padding: 1em;
  background: lightcyan;
  color: black;
  border-radius: 10px;
}
</style>
```

```{r, include = FALSE}
knitr::opts_chunk$set(
  #collapse = TRUE,
  comment = "#>",
  cache = TRUE,
  message = FALSE,
  warning = FALSE
)
```

Farhan Ameen$^{1,2,3}$, Shila Ghazanfar$^{2,3}$, Ellis
Patrick$^{1,2,3}$.

$^1$ Westmead Institute for Medical Research, University of Sydney,
Australia\
$^2$ Sydney Precision Data Science Centre, University of Sydney,
Australia\
$^3$ School of Mathematics and Statistics, University of Sydney,
Australia

<br/> Contact: ellis.patrick\@sydney.edu.au

## Overview

Understanding the interplay between different types of cells and their
immediate environment is critical for understanding the mechanisms of
cells themselves and their function in the context of human diseases.
Recent advances in high dimensional in situ cytometry technologies have
fundamentally revolutionized our ability to observe these complex
cellular relationships providing an unprecedented characterisation of
cellular heterogeneity in a tissue environment.

### Description

In this tutorial we will introduce an analytical framework for analysing
data from high dimensional spatial omics technologies such as, CODEX,
CycIF, IMC and High Definition Spatial Transcriptomics. This framework
makes use of functionality from our Bioconductor packages simpleSeg,
FuseSOM, scClassify, scHot, spicyR, listClust, statial, scFeatures and
ClassifyR. By the end of this tutorial attendees will be able to
implement and assess some of the key steps of a spatial analysis
pipeline including cell segmentation, feature normalisation, cell type
identification, microenvironment and cell-state characterisation,
spatial hypothesis testing and patient classification. Understanding
these key steps will provide attendees with the core skills needed to
interrogate the comprehensive spatial information generated by these
exciting new technologies.

### Pre-requisites

It is expected that students will have:

-   basic knowledge of R syntax,
-   familiarity with SingleCellExperiment and/or SpatialExperiment
    objects, and
-   this workshop will not provide an in-depth description of
    cell-resolution spatial omics technologies.

### *R* / *Bioconductor* packages used

Several single cell R packages will be used from the scdney package, for
more information visit: <https://sydneybiox.github.io/scdney/>

### Time outline

| Activity                               | Time   |
|----------------------------------------|--------|
| Data visualisation & cell segmentation | 1h 30m |
| Cell type clustering & classification  | 1h 30m |
| Spatial analysis & feature generation  | 2h     |
| Patient Classification                 | 1h 30m |

### Learning objectives

-   Understand and visualise spatial omics datasets.
-   Identify key biological questions that can be addressed with these
    technologies and spatial analysis.
-   Understand the key analytical steps involved in spatial omics
    analysis, and perform these steps using R.
-   Evaluate the performance of data normalisation and cell
    segmentation.\
-   Understand and generate individual feature representations from
    spatial omics data.
-   Develop appreciation on how to assess performance of classification
    models.
-   Perform disease outcome prediction using the feature representation
    and robust classification framework.

# Workshop

## Installation

```{r install, warning=FALSE, message=FALSE, eval = FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE)) {
    install.packages("BiocManager")
}

BiocManager::install(c( "simpleSeg", "cytomapper", "scClassify", "scHot", "FuseSOM", "spicyR", "lisaClust","Statial", "scFeatures", "ClassifyR", "tidyverse", "scater", "SingleCellExperiment", "STexampleData", "SpatialDatasets", "tidySingleCellExperiment", "scuttle", "batchelor"))
```

## Load packages

```{r library, warning=FALSE, message=FALSE}

library(ScdneySpatial)

# packages from scdney
library(simpleSeg)
library(scClassify)
library(scHOT)
library(FuseSOM)
library(spicyR)
library(lisaClust)
library(Statial)
library(scFeatures) 
library(ClassifyR)
library(SpatialDatasets)

# Other required packages
library(scater)
library(tidyverse)
library(SingleCellExperiment)
library(STexampleData)
library(cytomapper)
library(tidySingleCellExperiment)
library(scuttle)
library(batchelor)

theme_set(theme_classic())
nCores <- 1  # Feel free to parallelise things if you have the cores to spare.
source("data/celltype_colours.R")
```

## The data

We will use two motivating datasets:

-   [Keren et al,
    2018](https://www.cell.com/fulltext/S0092-8674(18)31100-0): A
    multiplexed ion beam imaging by time-of-flight (MIBI-TOF) dataset
    profilining tissue from triple-negative breast cancer patients.
-   [Lohoff et al,
    2022](https://www.nature.com/articles/s41587-021-01006-2): A seqFISH
    study of early mouse organogenesis. We will use a subset of data
    that is made available from the STExampleData package.

## Data visualisation and exploration

Here we will download the datasets, examine the structure, visualise the
data and perform some exploratory analyses.

### SeqFISH mouse embryo

Here we download the seqFISH mouse embryo data. This is a
`SpatialExperiment` object, which extends the `SingleCellExperiment`
object.

```{r seqFISHData}
spe <- STexampleData::seqFISH_mouseEmbryo()
spe
```

We can use functions designed for `SingleCellExperiment` objects in the
`scater` package for plotting via the `reducedDim` slot. We multiply the
spatial coordinates by a matrix to flip the y-axis and ensure we fix the
aspect ratio.

```{r visualiseSeqFISH}
spe <- logNormCounts(spe)
coord_transform <- matrix(c(1,0,0,-1), 2, 2, byrow = TRUE)
reducedDim(spe, "spatialCoords") <- spatialCoords(spe) %*% coord_transform
plotReducedDim(spe, "spatialCoords", colour_by = c("Sox2"), point_size = 1) +
  coord_fixed()
```

::: question
**Questions**

1.  How many cells are in this data?
2.  How many genes?
3.  Plot gene expression mapping point size to the cell area.
:::

```{r seqFISHQ1}
# try to answer the above question using the spe object. 
# you may want to check the SingleCellExperiment vignette.
# https://bioconductor.org/packages/3.17/bioc/vignettes/SingleCellExperiment/inst/doc/intro.html


```

We can perform a typical gene-expression based analysis for this data.
Later in part two we will perform some specific analytical techniques,
but for now let's explore the dataset and use methods designed for
single cell data.

Dimensionality reduction using PCA, batch correction across tiles using
the `batchelor` package, followed by UMAP and plotting.

```{r seqFISHEDA}
spe <- runPCA(spe)

b.out <- batchelor::batchCorrect(spe, batch = spe$pos, assay.type = "logcounts", PARAM=FastMnnParam(d=20))
reducedDim(spe, "FastMnn") <- reducedDim(b.out, "corrected")
spe <- runUMAP(spe, dimred = "FastMnn")
spe

g_celltype_umap <- plotReducedDim(spe, "UMAP", colour_by = "celltype_mapped_refined") + 
  scale_colour_manual(values = celltype_colours)
g_celltype_umap

plotReducedDim(spe, "UMAP", colour_by = "Sox2")

g_celltype_spatial <- plotReducedDim(spe, "spatialCoords", colour_by = "celltype_mapped_refined") + 
  scale_colour_manual(values = celltype_colours) + 
  coord_fixed()

g_all <- g_celltype_spatial + theme(legend.position = "none") + g_celltype_umap
g_all
```

::: question
**Advanced/Extension Question**

1.  What considerations need to be made for batch correction of spatial
    data? What assumptions are being made and/or broken? How could you
    check this?
2.  Check out the
    [`ggiraph`](https://davidgohel.github.io/ggiraph/index.html) package
    for extending the `g_all` object to an interactive plot with a
    tooltip that links the spatial and UMAP coordinate systems. (Hint:
    This may involve generating a new ggplot object outside of the
    `plotReducedDim` function.)
:::

```{r seqFISHQ2}
# try to examine answer the above questions using the spe object. 
# you may want to set up some small simulation..


```

At this point we will pause our examination of the seqFISH dataset that
is in the object `spe`, and turn over to the second example dataset. In
the second part we will revisit this data for performing `scHOT`
testing.

### MIBI-TOF breast cancer

Here we explore the MIBI-TOF breast cancer data, this is also a
`SpatialExperiment` object.

```{r kerenData}
kerenSPE = SpatialDatasets::spe_Keren_2018() 


kerenSPE = kerenSPE |> 
  filter(tumour_type != "cold",
         !is.na(`Survival_days_capped.`)) |> 
  mutate(event = 1 - Censored)


kerenSPE
```

::: question
**Questions**

1.  How many cells are in this data?
2.  How many markers? How many images?
:::

```{r kerenQ1}
# try to answer the above question using the imc object. 
# you may want to check the SingleCellExperiment vignette.
# https://www.bioconductor.org/packages/release/bioc/vignettes/SpatialExperiment/inst/doc/SpatialExperiment.html

```

Use the following code to run a UMAP `intensities` assay.

::: question
**Questions**

1.  Visualise the UMAP using the `plotReducedDim` function and colour
    the UMAP by `cellType`. What does this UMAP tell us?
2.  What are some observations we could make if we coloured by
    `imageID`?
:::

```{r kerenQ2}
set.seed(51773)
kerenSPE <- scater::runUMAP(kerenSPE, exprs_values = "intensities", name = "UMAP")


# try to answer the question here!
```

## Cell segmentation & evaluation

*TO FILL* - Waiting on tiff images

## Feature normalisation

*TO FILL* - Waiting on tiff images.



## Cell type annotation

### Cell type clustering 

#### Clustering cell types

Here we cluster using the `runFuseSOM` function from `FuseSOM`. We have
chosen to specify the same subset of markers used in the original
manuscript for gating cell types. We have also specified the number of
clusters to identify to be `numClusters = 10`.

```{r fuseSOM}

useMarkers = c("CD45", "FoxP3", "CD4", "CD8", "CD3", "CD20", "CD16", "CD68", "MPO", "HLA.DR", "Pan.Keratin", "Keratin17", "Keratin6", "p53", "Beta.catenin", "EGFR")

set.seed(51773)

kerenSPE <- runFuseSOM(
  kerenSPE,
  markers = useMarkers,
  assay = "intensities",
  numClusters = 10
)

```

#### Cluster Interpretation

We can begin the process of understanding what each of these cell
clusters are by using the `plotGroupedHeatmap` function from `scater`.

```{r heatmap}
scater::plotGroupedHeatmap(
  kerenSPE,
  features = useMarkers,
  group = "clusters",
  exprs_values = "intensities",
  center = TRUE,
  scale = TRUE,
  zlim = c(-3, 3),
  cluster_rows = FALSE
)
```

::: question
**Questions**

1.  Have we captured distinct cell populations? Can you identify any of
    the clusters?
2.  How does this compare to the heatmap of the original dataset,
    *Hint*: Plot the heatmap using `cellType` as the group.
:::

```{r clusteringQ1}
# Type your answer here
```

#### How do I determine an appropriate number of clusters?

Great question! We can use the `estimateNumCluster` and `optiPlot`
functions from `FuseSOM` to examine if our choice of 13 clusters is
reasonable. Here we use the gap statistic, other methods such as jump,
silhouette and within cluster distance are also available.

```{r optiPlot}
kerenSPE <- estimateNumCluster(kerenSPE, kSeq = 2:30)
optiPlot(kerenSPE, method = "gap")


kerenSPE@metadata$clusterEstimation$Discriminant
```

### Cell type classification

Cell type clustering may difficult without the aid of domain experts who
are able to annotate the the clusters. Cell type classification is an
alternative approach to clustering which anntates cell types based a
reference dataset.

*TO FILL* - Need a reference dataset with similar markers to keren: [1]
"Na" "Si" "P" "Ca" "Fe" "dsDNA"\
[7] "Vimentin" "SMA" "Background" "B7H3" "FoxP3" "Lag3"\
[13] "CD4" "CD16" "CD56" "OX40" "PD1" "CD31"\
[19] "PD.L1" "EGFR" "Ki67" "CD209" "CD11c" "CD138"\
[25] "CD163" "CD68" "CSF.1R" "CD8" "CD3" "IDO"\
[31] "Keratin17" "CD63" "CD45RO" "CD20" "p53" "Beta.catenin" [37]
"HLA.DR" "CD11b" "CD45" "H3K9ac" "Pan.Keratin" "H3K27me3"\
[43] "phospho.S6" "MPO" "Keratin6" "HLA_Class_1" "Ta" "Au"


### Viewing images

We can look at the distribution of cells in an image. Here we compare our clusters to the cell types in the dataset. 

```{r viewClustering}
reducedDim(kerenSPE, "spatialCoords") <- spatialCoords(kerenSPE)

kerenSPE |> 
  filter(imageID == "5") |> 
  plotReducedDim("spatialCoords", colour_by = "clusters") +
  ggtitle("Our clusters")


kerenSPE |> 
  filter(imageID == "5") |> 
  plotReducedDim("spatialCoords", colour_by = "cellType") +
  ggtitle("Dataset clusters")


```

## Feature generation